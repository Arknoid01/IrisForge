<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IrisForge Video - GÃ©nÃ©rateur de VidÃ©o</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f1e;
            background-image: radial-gradient(at 20% 30%, rgba(102,126,234,0.15) 0px, transparent 50%),
                              radial-gradient(at 80% 70%, rgba(118,75,162,0.15) 0px, transparent 50%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            background: rgba(255,255,255,0.03); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
            padding: 40px; max-width: 700px; margin: 0 auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            color: #fff; font-size: 32px; font-weight: 700; margin-bottom: 8px; text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #a78bfa 50%, #ec4899 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 30px; }
        .back-link { display: inline-block; color: #a78bfa; text-decoration: none; margin-bottom: 20px; font-size: 14px; }
        .back-link:hover { color: #667eea; }
        .form-group { margin-bottom: 24px; }
        label { display: block; color: #a78bfa; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        input[type="text"], input[type="number"], textarea {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 14px; color: #fff; font-size: 14px; transition: all 0.3s;
        }
        input:focus, textarea:focus {
            outline: none; border-color: #667eea;
            background: rgba(255,255,255,0.08); box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        .file-upload {
            position: relative; display: block; width: 100%; padding: 40px 20px;
            background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;
        }
        .file-upload:hover { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .file-upload input { display: none; }
        .file-upload-text { color: rgba(255,255,255,0.6); font-size: 14px; }
        .preview-img { max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 10px; }
        .info-box {
            background: rgba(102,126,234,0.1); border: 1px solid rgba(102,126,234,0.3);
            border-radius: 12px; padding: 16px; margin-bottom: 20px;
        }
        .info-box p { color: rgba(255,255,255,0.8); font-size: 13px; line-height: 1.6; margin: 4px 0; }
        .info-box strong { color: #a78bfa; }
        button {
            width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 12px; padding: 16px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(102,126,234,0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .mode-btn { transition: all 0.3s; cursor: pointer; font-size: 14px; font-weight: 500; }
        .mode-btn.active { background: rgba(102,126,234,0.3) !important; border-color: #667eea !important; }
        .duration-options { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
        .duration-option {
            flex: 1; min-width: 120px; padding: 16px; background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1); border-radius: 12px;
            cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .duration-option:hover { background: rgba(102,126,234,0.1); border-color: rgba(102,126,234,0.3); }
        .duration-option.selected { background: rgba(102,126,234,0.2); border-color: #667eea; }
        .duration-option .duration-label { color: #fff; font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .duration-option .duration-desc { color: rgba(255,255,255,0.6); font-size: 12px; }
        .duration-option .duration-badge { display: inline-block; margin-top: 6px; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-original { background: rgba(102,126,234,0.3); color: #a78bfa; }
        .badge-recommended { background: rgba(34,197,94,0.3); color: #4ade80; }
        .badge-quality { background: rgba(236,72,153,0.3); color: #f472b6; }
        .status { margin-top: 20px; padding: 12px; border-radius: 8px; text-align: center; font-size: 14px; display: none; }
        .status.success { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: #4ade80; }
        .status.error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #f87171; }
        .status.loading { background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); color: #fbbf24; }
        /* PROGRESS */
        .progress-container { margin-top: 16px; display: none; }
        .progress-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #a78bfa); border-radius: 4px; transition: width 0.3s ease; }
        .progress-label { text-align: center; color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 6px; }
        /* FRAME PREVIEW */
        .frame-preview-container { margin-top: 16px; display: none; text-align: center; }
        .frame-preview-container p { color: rgba(255,255,255,0.5); font-size: 12px; margin-bottom: 8px; }
        .frame-preview-img { max-width: 100%; max-height: 200px; border-radius: 10px; border: 1px solid rgba(102,126,234,0.3); box-shadow: 0 4px 20px rgba(102,126,234,0.2); }
        /* CHAINING */
        .chaining-box {
            background: rgba(167,139,250,0.08); border: 1px solid rgba(167,139,250,0.25);
            border-radius: 12px; padding: 16px; margin-bottom: 20px;
        }
        .chaining-row { display: flex; gap: 12px; align-items: center; margin-top: 10px; }
        .chaining-row span { color: rgba(255,255,255,0.6); font-size: 13px; }
        /* RESULT */
        .result-video { margin-top: 30px; text-align: center; display: none; }
        .result-video video { max-width: 100%; border-radius: 16px; box-shadow: 0 20px 50px rgba(102,126,234,0.3); }
        .download-btn { margin-top: 10px; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); }
        .next-clip-btn { margin-top: 10px; background: rgba(102,126,234,0.2); border: 1px solid rgba(102,126,234,0.4); display: none; }
        /* RECOVERY */
        .recovery-banner {
            background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3);
            border-radius: 12px; padding: 14px 16px; margin-bottom: 20px;
            display: none; align-items: center; justify-content: space-between; gap: 12px;
        }
        .recovery-banner p { color: rgba(255,255,255,0.8); font-size: 13px; }
        .recovery-btn { width: auto; padding: 8px 16px; font-size: 13px; background: rgba(251,191,36,0.3); border: 1px solid rgba(251,191,36,0.5); }
        .recovery-dismiss { width: auto; padding: 8px 16px; font-size: 13px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        /* GALLERY */
        .gallery-section { margin-top: 40px; display: none; }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .gallery-title { color: #a78bfa; font-size: 16px; font-weight: 600; }
        .gallery-actions { display: flex; gap: 8px; }
        .gallery-btn { padding: 8px 14px; font-size: 13px; border-radius: 8px; width: auto; }
        .assemble-btn { background: linear-gradient(135deg, #ec4899 0%, #a78bfa 100%); }
        .clear-btn { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
        .clip-card {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px; overflow: hidden; transition: all 0.3s; position: relative;
        }
        .clip-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .clip-card video { width: 100%; display: block; }
        .clip-card-footer { padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
        .clip-card-label { color: rgba(255,255,255,0.7); font-size: 12px; }
        .clip-card-actions { display: flex; gap: 6px; }
        .clip-action-btn {
            width: 28px; height: 28px; border-radius: 6px; border: none;
            cursor: pointer; font-size: 14px; display: flex; align-items: center;
            justify-content: center; transition: background 0.2s;
        }
        .clip-action-btn:hover { transform: none; box-shadow: none; }
        .clip-dl-btn { background: rgba(34,197,94,0.2); }
        .clip-dl-btn:hover { background: rgba(34,197,94,0.4); }
        .clip-chain-btn { background: rgba(102,126,234,0.2); }
        .clip-chain-btn:hover { background: rgba(102,126,234,0.4); }
        .clip-del-btn { background: rgba(239,68,68,0.2); }
        .clip-del-btn:hover { background: rgba(239,68,68,0.4); }
        .clip-num {
            position: absolute; top: 8px; left: 8px;
            background: rgba(0,0,0,0.6); color: #fff;
            font-size: 11px; font-weight: 700; padding: 3px 7px; border-radius: 6px;
        }
    </style>
</head>
<body>
<div class="container">
    <a href="index.html" class="back-link">â† Retour Ã  l'accueil</a>
    <h1>ğŸ¬ IrisForge Video</h1>
    <p class="subtitle">GÃ©nÃ©rateur de vidÃ©o avec chaÃ®nage automatique</p>

    <!-- RECOVERY -->
    <div class="recovery-banner" id="recoveryBanner">
        <p>âš ï¸ Une gÃ©nÃ©ration prÃ©cÃ©dente a Ã©tÃ© dÃ©tectÃ©e. RÃ©cupÃ©rer la vidÃ©o ?</p>
        <div style="display:flex;gap:8px;">
            <button class="recovery-btn" onclick="recoverLastGeneration()">âœ… RÃ©cupÃ©rer</button>
            <button class="recovery-dismiss" onclick="dismissRecovery()">âœ• Ignorer</button>
        </div>
    </div>

    <div class="form-group">
        <label>URL ComfyUI</label>
        <input type="text" id="comfyUrl" placeholder="http://127.0.0.1:8188" value="http://127.0.0.1:8188">
    </div>

    <div class="form-group">
        <label>Source de dÃ©part</label>
        <div style="display:flex;gap:12px;margin-bottom:12px;">
            <button type="button" class="mode-btn active" id="imageModeBtn" onclick="switchMode('image')" style="flex:1;padding:12px;background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);">ğŸ–¼ï¸ Image</button>
            <button type="button" class="mode-btn" id="videoModeBtn" onclick="switchMode('video')" style="flex:1;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);">ğŸ¬ VidÃ©o</button>
        </div>
        <div id="imageUploadSection">
            <label for="imageFile" class="file-upload">
                <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
                <div class="file-upload-text" id="imageFileText">ğŸ“¤ Cliquez pour choisir une image</div>
                <img id="imagePreview" class="preview-img" style="display:none">
            </label>
        </div>
        <div id="videoUploadSection" style="display:none;">
            <label for="videoFile" class="file-upload">
                <input type="file" id="videoFile" accept="video/*" onchange="previewVideo(event)">
                <div class="file-upload-text" id="videoFileText">ğŸ¬ Cliquez pour choisir une vidÃ©o</div>
                <video id="videoPreview" class="preview-img" style="display:none;max-width:100%;" controls></video>
            </label>
            <div style="margin-top:12px;padding:12px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;">
                <p style="color:rgba(255,255,255,0.7);font-size:13px;margin:0;">ğŸ’¡ La derniÃ¨re frame de votre vidÃ©o sera utilisÃ©e comme image de dÃ©part</p>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label>DurÃ©e du clip</label>
        <div class="duration-options">
            <div class="duration-option selected" onclick="selectDuration('2s')" id="duration2s">
                <div class="duration-label">~2 sec</div>
                <div class="duration-desc">49 frames</div>
                <div class="duration-badge badge-original">Original</div>
            </div>
            <div class="duration-option" onclick="selectDuration('4s')" id="duration4s">
                <div class="duration-label">~4 sec</div>
                <div class="duration-desc">98 frames</div>
                <div class="duration-badge badge-recommended">RecommandÃ©</div>
            </div>
            <div class="duration-option" onclick="selectDuration('7s')" id="duration7s">
                <div class="duration-label">~7 sec</div>
                <div class="duration-desc">81 frames + RIFE x2</div>
                <div class="duration-badge badge-quality">QualitÃ©+</div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label>Prompt (description du mouvement)</label>
        <textarea id="prompt" placeholder="Ex: dancing smoothly, fluid movements..."></textarea>
    </div>

    <div class="info-box">
        <p><strong>Configuration :</strong></p>
        <p id="durationInfo">â€¢ DurÃ©e : ~2 secondes (49 frames)</p>
        <p id="interpolationInfo">â€¢ Interpolation : Aucune (qualitÃ© maximale)</p>
        <p id="timeInfo">â€¢ Temps estimÃ© : variable selon GPU</p>
        <p>â€¢ RÃ©solution : 480x832 (portrait optimisÃ©)</p>
        <p>â€¢ FPS : 24 (cinÃ©matique)</p>
    </div>

    <!-- CHAINING -->
    <div class="chaining-box">
        <label>ğŸ”— ChaÃ®nage automatique</label>
        <p style="color:rgba(255,255,255,0.5);font-size:12px;margin-top:4px;">GÃ©nÃ¨re plusieurs clips en sÃ©quence. Chaque clip part de la derniÃ¨re frame du prÃ©cÃ©dent.</p>
        <div class="chaining-row">
            <input type="number" id="chainCount" value="1" min="1" max="20" style="max-width:100px;">
            <span>clip(s) Ã  gÃ©nÃ©rer</span>
        </div>
    </div>

    <button onclick="startGeneration()" id="generateBtn">ğŸ¬ GÃ©nÃ©rer</button>

    <div class="status" id="status"></div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
        <div class="progress-label" id="progressLabel">0 / 0</div>
    </div>

    <div class="frame-preview-container" id="framePreviewContainer">
        <p>ğŸï¸ Preview en cours de gÃ©nÃ©ration</p>
        <img class="frame-preview-img" id="framePreviewImg" src="" alt="preview">
    </div>

    <div class="result-video" id="resultVideo">
        <video id="finalVideo" controls></video>
        <button class="download-btn" onclick="downloadCurrentVideo()">ğŸ’¾ TÃ©lÃ©charger ce clip</button>
        <button class="next-clip-btn" id="nextClipBtn" onclick="generateNextClip()">â¡ï¸ GÃ©nÃ©rer le clip suivant depuis cette frame</button>
    </div>

    <!-- GALLERY -->
    <div class="gallery-section" id="gallerySection">
        <div class="gallery-header">
            <span class="gallery-title">ğŸ¬ Galerie (<span id="clipCount">0</span> clips)</span>
            <div class="gallery-actions">
                <button class="gallery-btn assemble-btn" onclick="assembleClips()">ğŸï¸ Assembler en MP4</button>
                <button class="gallery-btn clear-btn" onclick="clearGallery()">ğŸ—‘ï¸ Vider</button>
            </div>
        </div>
        <div class="gallery-grid" id="galleryGrid"></div>
    </div>
</div>

<script>
    // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let uploadedImage = null;
    let uploadedVideo = null;
    let currentMode = 'image';
    let selectedDuration = '2s';
    let clientId = Math.random().toString(36).substring(7);
    let currentVideoBlob = null;
    let currentVideoBlobUrl = null;
    let clips = [];
    let isGenerating = false;
    let chainRemaining = 0;
    let lastFrameImage = null;

    // â”€â”€ RECOVERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function saveGenerationState(promptId, saveNodeId, apiUrl) {
        localStorage.setItem('irisforge_pending', JSON.stringify({ promptId, saveNodeId, apiUrl, ts: Date.now() }));
    }
    function clearGenerationState() { localStorage.removeItem('irisforge_pending'); }

    function checkRecovery() {
        try {
            const saved = localStorage.getItem('irisforge_pending');
            if (!saved) return;
            const data = JSON.parse(saved);
            if (Date.now() - data.ts < 7200000) {
                document.getElementById('recoveryBanner').style.display = 'flex';
            } else { clearGenerationState(); }
        } catch(e) { clearGenerationState(); }
    }

    function dismissRecovery() {
        clearGenerationState();
        document.getElementById('recoveryBanner').style.display = 'none';
    }

    async function recoverLastGeneration() {
        let saved;
        try { saved = localStorage.getItem('irisforge_pending'); } catch(e) {}
        if (!saved) return;
        let data;
        try { data = JSON.parse(saved); } catch(e) { clearGenerationState(); return; }
        const { promptId, saveNodeId, apiUrl } = data;
        document.getElementById('recoveryBanner').style.display = 'none';
        showStatus('ğŸ” RÃ©cupÃ©ration de la vidÃ©o...', 'loading');
        try {
            const hist = await (await fetch(`${apiUrl}/history/${promptId}`)).json();
            if (hist[promptId] && hist[promptId].outputs) {
                const saveNode = hist[promptId].outputs[saveNodeId];
                const videoInfo = saveNode ? (saveNode.videos || saveNode.images || saveNode.gifs || [])[0] : null;
                if (videoInfo) {
                    const videoUrl = `${apiUrl}/view?filename=${encodeURIComponent(videoInfo.filename)}&subfolder=${encodeURIComponent(videoInfo.subfolder||'')}&type=${encodeURIComponent(videoInfo.type||'output')}`;
                    const blob = await (await fetch(videoUrl)).blob();
                    clearGenerationState();
                    addClipToGallery(blob, selectedDuration);
                    showStatus('âœ… VidÃ©o rÃ©cupÃ©rÃ©e et ajoutÃ©e Ã  la galerie !', 'success');
                } else {
                    showStatus('âš ï¸ GÃ©nÃ©ration pas encore terminÃ©e ou introuvable.', 'error');
                    clearGenerationState();
                }
            } else { showStatus('âš ï¸ Aucun rÃ©sultat trouvÃ©.', 'error'); clearGenerationState(); }
        } catch(e) { showStatus('âŒ Erreur rÃ©cupÃ©ration : ' + e.message, 'error'); }
    }

    // â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showStatus(msg, type) {
        const s = document.getElementById('status');
        s.textContent = msg; s.className = 'status ' + type; s.style.display = 'block';
    }
    function showProgress(val, max) {
        document.getElementById('progressContainer').style.display = 'block';
        const pct = max > 0 ? Math.round((val / max) * 100) : 0;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressLabel').textContent = `Step ${val} / ${max} (${pct}%)`;
    }
    function hideProgress() {
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('progressFill').style.width = '0%';
    }
    function showFramePreview(url) {
        document.getElementById('framePreviewImg').src = url;
        document.getElementById('framePreviewContainer').style.display = 'block';
    }
    function hideFramePreview() {
        document.getElementById('framePreviewContainer').style.display = 'none';
        document.getElementById('framePreviewImg').src = '';
    }
    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('imageModeBtn').classList.toggle('active', mode === 'image');
        document.getElementById('videoModeBtn').classList.toggle('active', mode === 'video');
        document.getElementById('imageUploadSection').style.display = mode === 'image' ? 'block' : 'none';
        document.getElementById('videoUploadSection').style.display = mode === 'video' ? 'block' : 'none';
    }
    function selectDuration(d) {
        selectedDuration = d;
        document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected'));
        document.getElementById('duration' + d).classList.add('selected');
        updateInfo();
    }
    function updateInfo() {
        const infoMap = {
            '2s': { dur: '~2 secondes (49 frames)', interp: 'Aucune (qualitÃ© maximale)', time: 'variable selon GPU' },
            '4s': { dur: '~4 secondes (98 frames)', interp: 'RIFE x2 (bonne qualitÃ©)', time: 'variable selon GPU' },
            '7s': { dur: '~7 secondes (81 frames + RIFE x2)', interp: 'RIFE x2 sur 81 vraies frames (trÃ¨s bonne qualitÃ©)', time: 'variable selon GPU (~2x le mode 2s)' }
        };
        const info = infoMap[selectedDuration] || infoMap['2s'];
        document.getElementById('durationInfo').textContent = 'â€¢ DurÃ©e : ' + info.dur;
        document.getElementById('interpolationInfo').textContent = 'â€¢ Interpolation : ' + info.interp;
        document.getElementById('timeInfo').textContent = 'â€¢ Temps estimÃ© : ' + info.time;
    }

    // â”€â”€ IMAGE/VIDEO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImage = e.target.result;
            lastFrameImage = e.target.result;
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('imageFileText').textContent = 'âœ” ' + file.name;
        };
        reader.readAsDataURL(file);
    }

    function previewVideo(event) {
        const file = event.target.files[0];
        if (!file) return;
        // Revoke previous object URL if any
        const vid = document.getElementById('videoPreview');
        if (vid.src && vid.src.startsWith('blob:')) URL.revokeObjectURL(vid.src);
        const url = URL.createObjectURL(file);
        uploadedVideo = file;
        uploadedImage = null; // reset until frame is extracted
        lastFrameImage = null;
        vid.src = url; vid.style.display = 'block';
        document.getElementById('videoFileText').textContent = 'âœ” ' + file.name;
        vid.onloadedmetadata = () => extractLastFrame(vid);
    }

    function extractLastFrame(video) {
        video.currentTime = Math.max(0, video.duration - 0.1);
        video.onseeked = function() {
            video.onseeked = null;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 480;
            canvas.height = video.videoHeight || 832;
            canvas.getContext('2d').drawImage(video, 0, 0);
            uploadedImage = canvas.toDataURL('image/png');
            lastFrameImage = uploadedImage;
            showStatus('âœ” DerniÃ¨re frame extraite !', 'success');
            setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
        };
    }

    function extractLastFrameFromBlob(blob) {
        return new Promise((resolve, reject) => {
            const url = URL.createObjectURL(blob);
            const video = document.createElement('video');
            const timeout = setTimeout(() => {
                URL.revokeObjectURL(url);
                reject(new Error('Timeout extraction frame'));
            }, 15000);
            video.onloadedmetadata = () => {
                video.currentTime = Math.max(0, video.duration - 0.1);
                video.onseeked = () => {
                    clearTimeout(timeout);
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth || 480;
                    canvas.height = video.videoHeight || 832;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
            };
            video.onerror = () => { clearTimeout(timeout); URL.revokeObjectURL(url); reject(new Error('Erreur chargement vidÃ©o')); };
            video.src = url;
        });
    }

    // â”€â”€ COMFYUI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function uploadImageToComfyUI(apiUrl, imageBase64) {
        const blob = await (await fetch(imageBase64)).blob();
        const formData = new FormData();
        formData.append('image', blob, `video_source_${Date.now()}.png`);
        formData.append('overwrite', 'true');
        const res = await fetch(`${apiUrl}/upload/image`, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`Erreur upload image (${res.status})`);
        return (await res.json()).name;
    }

    async function generateWithInterpolation(apiUrl, imageName, prompt) {
        return new Promise((resolve, reject) => {
            const seed = Math.floor(Math.random() * 1000000000000000);
            const uniquePrefix = `video/video_${Date.now()}`;

            // Nombre de frames selon durÃ©e
            const framesMap = { '2s': 49, '4s': 49, '7s': 81 };
            const frameCount = framesMap[selectedDuration] || 49;

            const workflow = {
                "84": { inputs: { clip_name: "umt5_xxl_fp8_e4m3fn_scaled.safetensors", type: "wan" }, class_type: "CLIPLoader" },
                "90": { inputs: { vae_name: "wan_2.1_vae.safetensors" }, class_type: "VAELoader" },
                "95": { inputs: { unet_name: "Wan2_2-I2V-A14B-HIGH_fp8_e4m3fn_scaled_KJ.safetensors", weight_dtype: "default" }, class_type: "UNETLoader" },
                "96": { inputs: { unet_name: "Wan2_2-I2V-A14B-LOW_fp8_e4m3fn_scaled_KJ.safetensors", weight_dtype: "default" }, class_type: "UNETLoader" },
                "97": { inputs: { image: imageName, upload: "image" }, class_type: "LoadImage" },
                "120": { inputs: { upscale_method: "lanczos", width: 480, height: 832, crop: "disabled", image: ["97", 0] }, class_type: "ImageScale" },
                "93": { inputs: { text: prompt, clip: ["84", 0] }, class_type: "CLIPTextEncode" },
                "89": { inputs: { text: "blurry, blur, out of focus, soft focus, unfocused, low quality, low resolution, pixelated, compression artifacts, jpeg artifacts, hazy, foggy, static, still image, frozen, no movement, worst quality, bad quality, ugly, distorted, deformed", clip: ["84", 0] }, class_type: "CLIPTextEncode" },
                "101": { inputs: { lora_name: "loras/Wan21_I2V_14B_lightx2v_cfg_step_distill_lora_rank64.safetensors", strength_model: 0.15, model: ["95", 0] }, class_type: "LoraLoaderModelOnly" },
                "102": { inputs: { lora_name: "DetailTweaker.safetensors", strength_model: 0.15, model: ["96", 0] }, class_type: "LoraLoaderModelOnly" },
                "103": { inputs: { shift: 5.0, model: ["102", 0] }, class_type: "ModelSamplingSD3" },
                "104": { inputs: { shift: 5.0, model: ["101", 0] }, class_type: "ModelSamplingSD3" },
                "98": { inputs: { width: 480, height: 832, length: frameCount, batch_size: 1, positive: ["93", 0], negative: ["89", 0], vae: ["90", 0], start_image: ["120", 0] }, class_type: "WanImageToVideo" },
                "86": { inputs: { add_noise: "enable", noise_seed: seed, steps: 18, cfg: 2.5, sampler_name: "euler_ancestral", scheduler: "normal", start_at_step: 0, end_at_step: 9, return_with_leftover_noise: "enable", model: ["104", 0], positive: ["98", 0], negative: ["98", 1], latent_image: ["98", 2] }, class_type: "KSamplerAdvanced" },
                "85": { inputs: { add_noise: "disable", noise_seed: seed, steps: 18, cfg: 2.5, sampler_name: "euler_ancestral", scheduler: "normal", start_at_step: 9, end_at_step: 18, return_with_leftover_noise: "disable", model: ["103", 0], positive: ["98", 0], negative: ["98", 1], latent_image: ["86", 0] }, class_type: "KSamplerAdvanced" },
                "87": { inputs: { samples: ["85", 0], vae: ["90", 0] }, class_type: "VAEDecode" }
            };

            let nodeId = 200;
            let lastOutput = ["87", 0];

            // RIFE pour 4s (x2) et 7s (x2 sur 81 frames)
            if (selectedDuration === '4s' || selectedDuration === '7s') {
                workflow[String(nodeId)] = {
                    inputs: { frames: lastOutput, ckpt_name: "rife47.pth", clear_cache_after_n_frames: 10, multiplier: 2, fast_mode: true, ensemble: true, scale_factor: 1 },
                    class_type: "RIFE VFI"
                };
                lastOutput = [String(nodeId), 0];
                nodeId++;
            }

            const createId = String(nodeId++);
            workflow[createId] = { inputs: { fps: 24, images: lastOutput }, class_type: "CreateVideo" };

            const saveNodeId = String(nodeId);
            workflow[saveNodeId] = { inputs: { filename_prefix: uniquePrefix, format: "mp4", codec: "h264", video: [createId, 0] }, class_type: "SaveVideo" };

            fetch(`${apiUrl}/prompt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: workflow, client_id: clientId })
            })
            .then(r => { if (!r.ok) throw new Error(`Erreur ComfyUI (${r.status})`); return r.json(); })
            .then(data => {
                const promptId = data.prompt_id;
                if (!promptId) throw new Error('Pas de prompt_id dans la rÃ©ponse');
                saveGenerationState(promptId, saveNodeId, apiUrl);

                const wsUrl = apiUrl.replace(/^http/, 'ws');
                const ws = new WebSocket(`${wsUrl}/ws?clientId=${clientId}`);

                ws.onmessage = async (event) => {
                    let msg;
                    try { msg = JSON.parse(event.data); } catch(e) { return; }

                    if (msg.type === 'progress' && msg.data.prompt_id === promptId) {
                        showProgress(msg.data.value, msg.data.max);
                    }

                    if (msg.type === 'executed' && msg.data.prompt_id === promptId && msg.data.output) {
                        const images = msg.data.output.images || [];
                        if (images.length > 0) {
                            const img = images[0];
                            showFramePreview(`${apiUrl}/view?filename=${encodeURIComponent(img.filename)}&subfolder=${encodeURIComponent(img.subfolder||'')}&type=${encodeURIComponent(img.type||'output')}`);
                        }
                    }

                    if (msg.type === 'executing' && msg.data.prompt_id === promptId && msg.data.node === null) {
                        setTimeout(async () => {
                            try {
                                const histRes = await fetch(`${apiUrl}/history/${promptId}`);
                                if (!histRes.ok) throw new Error(`Erreur historique (${histRes.status})`);
                                const hist = await histRes.json();
                                if (hist[promptId] && hist[promptId].outputs) {
                                    const saveNode = hist[promptId].outputs[saveNodeId];
                                    const videoInfo = saveNode ? (saveNode.videos || saveNode.images || saveNode.gifs || [])[0] : null;
                                    if (videoInfo) {
                                        const videoUrl = `${apiUrl}/view?filename=${encodeURIComponent(videoInfo.filename)}&subfolder=${encodeURIComponent(videoInfo.subfolder||'')}&type=${encodeURIComponent(videoInfo.type||'output')}`;
                                        const videoRes = await fetch(videoUrl);
                                        if (!videoRes.ok) throw new Error(`Erreur tÃ©lÃ©chargement vidÃ©o (${videoRes.status})`);
                                        const videoBlob = await videoRes.blob();
                                        clearGenerationState();
                                        safeResolve({ videoBlob });
                                    } else { throw new Error('Aucune vidÃ©o dans la rÃ©ponse ComfyUI'); }
                                } else { throw new Error('Historique introuvable'); }
                            } catch(err) { safeReject(err); }
                        }, 1000);
                    }
                };

                let settled = false;
                const safeResolve = (val) => { if (!settled) { settled = true; ws.close(); resolve(val); } };
                const safeReject  = (err) => { if (!settled) { settled = true; ws.close(); reject(err);  } };
                ws.onerror = () => safeReject(new Error('Erreur WebSocket â€” vÃ©rifiez que ComfyUI est accessible'));
                ws.onclose = (e) => { if (!settled && !e.wasClean && e.code !== 1000) safeReject(new Error('WebSocket fermÃ© inopinÃ©ment')); };
            })
            .catch(reject);
        });
    }

    // â”€â”€ GENERATION FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function startGeneration() {
        if (isGenerating) return;
        const apiUrl = document.getElementById('comfyUrl').value.trim();
        const prompt = document.getElementById('prompt').value.trim();
        const chainCount = Math.max(1, parseInt(document.getElementById('chainCount').value) || 1);

        if (!apiUrl) { showStatus('âŒ Veuillez entrer l\'URL ComfyUI', 'error'); return; }
        if (!prompt) { showStatus('âŒ Veuillez entrer un prompt', 'error'); return; }
        if (currentMode === 'image' && !uploadedImage) { showStatus('âŒ Veuillez uploader une image', 'error'); return; }
        if (currentMode === 'video' && !uploadedImage) { showStatus('âŒ Extraction de la frame en cours, patientez...', 'error'); return; }

        chainRemaining = chainCount;
        lastFrameImage = uploadedImage;
        await runNextClip(apiUrl, prompt);
    }

    async function runNextClip(apiUrl, prompt) {
        if (chainRemaining <= 0 || !lastFrameImage) return;
        isGenerating = true;
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('nextClipBtn').style.display = 'none';
        document.getElementById('resultVideo').style.display = 'none';
        hideProgress(); hideFramePreview();

        const clipIndex = clips.length + 1;
        const totalExpected = clipIndex + chainRemaining - 1;

        try {
            showStatus(`ğŸ“¤ Upload image source (clip ${clipIndex}/${totalExpected})...`, 'loading');
            const imageName = await uploadImageToComfyUI(apiUrl, lastFrameImage);
            showStatus(`ğŸ¬ GÃ©nÃ©ration clip ${clipIndex}/${totalExpected}...`, 'loading');
            const { videoBlob } = await generateWithInterpolation(apiUrl, imageName, prompt);

            // Revoke previous result URL to free memory
            if (currentVideoBlobUrl) { URL.revokeObjectURL(currentVideoBlobUrl); currentVideoBlobUrl = null; }

            addClipToGallery(videoBlob, selectedDuration);
            currentVideoBlob = videoBlob;
            currentVideoBlobUrl = URL.createObjectURL(videoBlob);
            document.getElementById('finalVideo').src = currentVideoBlobUrl;
            document.getElementById('resultVideo').style.display = 'block';

            // Extract last frame for chaining
            lastFrameImage = await extractLastFrameFromBlob(videoBlob);

            chainRemaining--;
            hideProgress(); hideFramePreview();

            if (chainRemaining > 0) {
                showStatus(`âœ… Clip ${clipIndex} terminÃ© ! Lancement du suivant...`, 'success');
                setTimeout(() => runNextClip(apiUrl, prompt), 800);
            } else {
                showStatus(`âœ… ${clips.length} clip(s) gÃ©nÃ©rÃ©s avec succÃ¨s !`, 'success');
                document.getElementById('nextClipBtn').style.display = 'block';
                isGenerating = false;
                document.getElementById('generateBtn').disabled = false;
            }
        } catch(err) {
            hideProgress(); hideFramePreview();
            showStatus('âŒ Erreur : ' + err.message, 'error');
            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            if (clips.length > 0) document.getElementById('nextClipBtn').style.display = 'block';
        }
    }

    async function generateNextClip() {
        const apiUrl = document.getElementById('comfyUrl').value.trim();
        const prompt = document.getElementById('prompt').value.trim();
        if (!apiUrl) { showStatus('âŒ Veuillez entrer l\'URL ComfyUI', 'error'); return; }
        if (!prompt) { showStatus('âŒ Veuillez entrer un prompt', 'error'); return; }
        if (!lastFrameImage) { showStatus('âŒ Aucune frame source disponible', 'error'); return; }
        chainRemaining = 1;
        await runNextClip(apiUrl, prompt);
    }

    // â”€â”€ GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addClipToGallery(blob, duration) {
        const url = URL.createObjectURL(blob);
        clips.push({ blob, url, label: `Clip ${clips.length + 1} (~${duration})` });
        renderGallery();
    }

    function renderGallery() {
        const grid = document.getElementById('galleryGrid');
        const section = document.getElementById('gallerySection');
        document.getElementById('clipCount').textContent = clips.length;
        section.style.display = clips.length > 0 ? 'block' : 'none';
        grid.innerHTML = '';
        clips.forEach((clip, i) => {
            const card = document.createElement('div');
            card.className = 'clip-card';
            card.innerHTML = `
                <span class="clip-num">#${i + 1}</span>
                <video src="${clip.url}" controls muted loop playsinline></video>
                <div class="clip-card-footer">
                    <span class="clip-card-label">${clip.label}</span>
                    <div class="clip-card-actions">
                        <button class="clip-action-btn clip-chain-btn" onclick="useClipAsSource(${i})" title="Utiliser comme source">ğŸ”—</button>
                        <button class="clip-action-btn clip-dl-btn" onclick="downloadClip(${i})" title="TÃ©lÃ©charger">ğŸ’¾</button>
                        <button class="clip-action-btn clip-del-btn" onclick="deleteClip(${i})" title="Supprimer">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            grid.appendChild(card);
        });
    }

    function downloadClip(i) {
        if (i < 0 || i >= clips.length) return;
        const a = document.createElement('a');
        a.href = clips[i].url;
        a.download = `irisforge_clip_${i+1}_${Date.now()}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function deleteClip(i) {
        if (i < 0 || i >= clips.length) return;
        URL.revokeObjectURL(clips[i].url);
        clips.splice(i, 1);
        clips.forEach((c, idx) => c.label = `Clip ${idx+1} (~${selectedDuration})`);
        renderGallery();
    }

    async function useClipAsSource(i) {
        if (i < 0 || i >= clips.length) return;
        showStatus('ğŸ”— Extraction de la derniÃ¨re frame...', 'loading');
        try {
            lastFrameImage = await extractLastFrameFromBlob(clips[i].blob);
            uploadedImage = lastFrameImage;
            document.getElementById('imagePreview').src = lastFrameImage;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('imageFileText').innerHTML = `âœ” DerniÃ¨re frame du clip #${i+1}`;
            switchMode('image');
            showStatus(`âœ… Clip #${i+1} dÃ©fini comme source !`, 'success');
            setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
        } catch(e) {
            showStatus('âŒ Erreur extraction frame : ' + e.message, 'error');
        }
    }

    function clearGallery() {
        if (!confirm('Vider toute la galerie ? Cette action est irrÃ©versible.')) return;
        clips.forEach(c => URL.revokeObjectURL(c.url));
        clips = [];
        lastFrameImage = uploadedImage;
        renderGallery();
    }

    // â”€â”€ ASSEMBLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function assembleClips() {
        if (clips.length === 0) { showStatus('âŒ Aucun clip dans la galerie', 'error'); return; }
        if (clips.length === 1) { downloadClip(0); return; }

        showStatus('ğŸï¸ Assemblage en cours...', 'loading');
        try {
            const videoElements = clips.map(c => {
                const v = document.createElement('video');
                v.src = c.url; v.muted = true; v.playsInline = true;
                return v;
            });

            // Load all metadata
            await Promise.all(videoElements.map(v => new Promise((res, rej) => {
                v.onloadedmetadata = res;
                v.onerror = () => rej(new Error('Erreur chargement clip'));
                v.load();
            })));

            const W = videoElements[0].videoWidth || 480;
            const H = videoElements[0].videoHeight || 832;
            const canvas = document.createElement('canvas');
            canvas.width = W; canvas.height = H;
            const ctx = canvas.getContext('2d');

            const stream = canvas.captureStream(24);
            const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : 'video/webm';
            const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 8000000 });
            const chunks = [];
            recorder.ondataavailable = e => { if (e.data && e.data.size > 0) chunks.push(e.data); };
            recorder.start(100);

            for (let i = 0; i < videoElements.length; i++) {
                showStatus(`ğŸï¸ Assemblage clip ${i+1}/${videoElements.length}...`, 'loading');
                const v = videoElements[i];
                await new Promise((res) => {
                    v.currentTime = 0;
                    let animId;
                    let drawing = true;
                    const draw = () => {
                        if (!drawing) return;
                        ctx.drawImage(v, 0, 0, W, H);
                        animId = requestAnimationFrame(draw);
                    };
                    v.onended = () => { drawing = false; cancelAnimationFrame(animId); res(); };
                    v.onerror = () => { cancelAnimationFrame(animId); res(); }; // skip errored clip
                    v.play().then(() => { animId = requestAnimationFrame(draw); }).catch(res);
                });
                v.pause();
            }

            recorder.stop();
            await new Promise(res => recorder.onstop = res);

            const finalBlob = new Blob(chunks, { type: mimeType });
            const url = URL.createObjectURL(finalBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `irisforge_assembled_${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 5000);
            showStatus(`âœ… VidÃ©o assemblÃ©e tÃ©lÃ©chargÃ©e (${clips.length} clips) !`, 'success');
        } catch(err) { showStatus('âŒ Erreur assemblage : ' + err.message, 'error'); }
    }

    // â”€â”€ DOWNLOAD CURRENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function downloadCurrentVideo() {
        if (!currentVideoBlob) return;
        const url = URL.createObjectURL(currentVideoBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `irisforge_clip_${Date.now()}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    updateInfo();
    checkRecovery();

    window.addEventListener('load', () => {
        try {
            const img = localStorage.getItem('videoSourceImage');
            if (img && img.startsWith('data:image/')) {
                uploadedImage = img; lastFrameImage = img;
                document.getElementById('imagePreview').src = img;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('imageFileText').innerHTML = 'âœ” Image chargÃ©e depuis IrisForge<br><small style="color:rgba(255,255,255,0.5)">Vous pouvez changer l\'image</small>';
                localStorage.removeItem('videoSourceImage');
                showStatus('âœ” Image chargÃ©e depuis IrisForge !', 'success');
                setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
            }
        } catch(e) { console.warn('Erreur lecture localStorage:', e); }
    });
</script>
</body>
</html>

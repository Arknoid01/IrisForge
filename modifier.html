<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IrisForge Modifier - √âdition Vid√©o</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f1e;
            background-image: radial-gradient(at 20% 30%, rgba(102,126,234,0.15) 0px, transparent 50%),
                              radial-gradient(at 80% 70%, rgba(118,75,162,0.15) 0px, transparent 50%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            background: rgba(255,255,255,0.03); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
            padding: 40px; padding-top: 68px; max-width: 700px; margin: 0 auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            color: #fff; font-size: 32px; font-weight: 700; margin-bottom: 8px; text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #a78bfa 50%, #ec4899 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 30px; }
        .form-group { margin-bottom: 24px; }
        label { display: block; color: #a78bfa; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        input[type="text"], input[type="number"], textarea {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 14px; color: #fff; font-size: 14px; transition: all 0.3s;
        }
        input:focus, textarea:focus {
            outline: none; border-color: #667eea;
            background: rgba(255,255,255,0.08); box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        .file-upload {
            position: relative; display: block; width: 100%; padding: 40px 20px;
            background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;
        }
        .file-upload:hover { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .file-upload input { display: none; }
        .file-upload-text { color: rgba(255,255,255,0.6); font-size: 14px; }
        .preview-video { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 10px; }
        button {
            width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 12px; padding: 16px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(102,126,234,0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .status { margin-top: 20px; padding: 12px; border-radius: 8px; text-align: center; font-size: 14px; display: none; }
        .status.success { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: #4ade80; }
        .status.error   { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #f87171; }
        .status.loading { background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); color: #fbbf24; }
        .info-box {
            background: rgba(102,126,234,0.1); border: 1px solid rgba(102,126,234,0.3);
            border-radius: 12px; padding: 16px; margin-bottom: 20px;
        }
        .info-box p { color: rgba(255,255,255,0.8); font-size: 13px; line-height: 1.6; margin: 4px 0; }
        .info-box strong { color: #a78bfa; }
        /* Strength slider */
        .slider-group { margin-bottom: 24px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .slider-header label { margin-bottom: 0; }
        .slider-value {
            background: rgba(102,126,234,0.2); border: 1px solid rgba(102,126,234,0.4);
            border-radius: 8px; padding: 4px 12px; color: #a78bfa; font-size: 13px; font-weight: 700;
        }
        input[type="range"] {
            width: 100%; -webkit-appearance: none; height: 6px;
            background: rgba(255,255,255,0.1); border-radius: 3px; outline: none; padding: 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #a78bfa); cursor: pointer;
            box-shadow: 0 2px 8px rgba(102,126,234,0.5);
        }
        .strength-labels { display: flex; justify-content: space-between; margin-top: 6px; }
        .strength-labels span { color: rgba(255,255,255,0.4); font-size: 11px; }
        /* Progress */
        .progress-container { margin-top: 16px; display: none; }
        .progress-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #a78bfa); border-radius: 4px; transition: width 0.3s ease; }
        .progress-label { text-align: center; color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 6px; }
        /* Result */
        .result-video { margin-top: 30px; text-align: center; display: none; }
        .result-video video { max-width: 100%; border-radius: 16px; box-shadow: 0 20px 50px rgba(102,126,234,0.3); }
        .download-btn { margin-top: 10px; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); }
        /* Traduction */
        .translate-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .translate-label-row label { margin-bottom: 0; }
        .translate-btn {
            background: rgba(102,126,234,0.2); border: 1px solid rgba(102,126,234,0.4);
            border-radius: 8px; padding: 4px 12px; color: #a78bfa;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; white-space: nowrap; width: auto;
        }
        .translate-btn:hover { background: rgba(102,126,234,0.4); color: #fff; transform: none; box-shadow: none; }
        .translate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .translate-btn.success { background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.4); color: #4ade80; }
        .translate-btn.error   { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.4); color: #f87171; }
        /* Sidebar */
        .menu-btn { position: fixed; top: 20px; left: 20px; width: 36px; height: 36px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 9px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; cursor: pointer; z-index: 1000; transition: all 0.3s; }
        .menu-btn:hover { background: rgba(167,139,250,0.15); border-color: rgba(167,139,250,0.4); }
        .menu-btn span { display: block; width: 16px; height: 2px; background: rgba(255,255,255,0.8); border-radius: 2px; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1001; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sidebar-overlay.open { opacity: 1; pointer-events: all; }
        .sidebar { position: fixed; top: 0; left: 0; width: 260px; height: 100vh; background: #0f0f1e; border-right: 1px solid rgba(255,255,255,0.1); z-index: 1002; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); display: flex; flex-direction: column; padding: 24px 16px; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.07); }
        .sidebar-title { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #667eea, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sidebar-close { width: 28px; height: 28px; border-radius: 7px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .sidebar-close:hover { background: rgba(239,68,68,0.2); color: #f87171; }
        .sidebar-nav { display: flex; flex-direction: column; gap: 4px; }
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 10px; text-decoration: none; color: rgba(255,255,255,0.7); font-size: 14px; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
        .sidebar-link:hover { background: rgba(167,139,250,0.1); border-color: rgba(167,139,250,0.2); color: #fff; }
        .sidebar-link.active { background: rgba(102,126,234,0.15); border-color: rgba(102,126,234,0.3); color: #a78bfa; }
        .sidebar-link .icon { font-size: 18px; width: 24px; text-align: center; }
        .sidebar-divider { height: 1px; background: rgba(255,255,255,0.07); margin: 8px 0; }
    </style>
</head>
<body>

    <!-- Menu -->
    <div class="menu-btn" onclick="toggleSidebar()"><span></span><span></span><span></span></div>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üî• IrisForge</div>
            <div class="sidebar-close" onclick="toggleSidebar()">‚úï</div>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="sidebar-link"><span class="icon">üè†</span> Accueil</a>
            <div class="sidebar-divider"></div>
            <a href="forge.html" class="sidebar-link"><span class="icon">üé®</span> IrisForge 2.0</a>
            <a href="base.html" class="sidebar-link"><span class="icon">‚ö°</span> Base</a>
            <a href="editor.html" class="sidebar-link"><span class="icon">‚úèÔ∏è</span> √âditeur</a>
            <a href="video.html" class="sidebar-link"><span class="icon">üé¨</span> Vid√©o</a>
            <a href="modifier.html" class="sidebar-link active"><span class="icon">üé≠</span> Modifier Vid√©o</a>
            <a href="assemblage.html" class="sidebar-link"><span class="icon">üéûÔ∏è</span> Assemblage</a>
            <div class="sidebar-divider"></div>
            <a href="historique.html" class="sidebar-link"><span class="icon">üìú</span> Historique</a>
        </nav>
    </div>

<div class="container">

    <h1>üé≠ IrisForge Modifier</h1>
    <p class="subtitle">Modifie une vid√©o existante avec un prompt ‚Äî propuls√© par CogVideoX</p>

    <div class="form-group">
        <label>URL ComfyUI</label>
        <input type="text" id="comfyUrl" placeholder="http://127.0.0.1:8188">
    </div>

    <div class="form-group">
        <label>Vid√©o source</label>
        <label for="videoFile" class="file-upload">
            <input type="file" id="videoFile" accept="video/*" onchange="previewVideo(event)">
            <div class="file-upload-text" id="videoFileText">üé¨ Cliquez pour choisir une vid√©o</div>
            <video id="videoPreview" class="preview-video" style="display:none;" controls muted></video>
        </label>
    </div>

    <div class="form-group">
        <div class="translate-label-row">
            <label>Prompt de modification</label>
            <button type="button" class="translate-btn" onclick="triggerTranslate('prompt', this)">üåê FR‚ÜíEN</button>
        </div>
        <textarea id="prompt" placeholder="Ex: transform into anime style, add dramatic lighting, make it look cinematic..."></textarea>
    </div>

    <!-- Strength slider -->
    <div class="slider-group">
        <div class="slider-header">
            <label>Force de modification</label>
            <span class="slider-value" id="strengthValue">0.55</span>
        </div>
        <input type="range" id="strengthSlider" min="0.1" max="0.95" step="0.05" value="0.55"
               oninput="document.getElementById('strengthValue').textContent = parseFloat(this.value).toFixed(2)">
        <div class="strength-labels">
            <span>üîí Subtil (0.1)</span>
            <span>‚öñÔ∏è √âquilibr√© (0.55)</span>
            <span>üî• Radical (0.95)</span>
        </div>
    </div>

    <div class="info-box">
        <p><strong>CogVideoX Video-to-Video</strong></p>
        <p>‚Ä¢ <strong>Force faible (0.1‚Äì0.3)</strong> : l√©g√®res retouches de style, couleurs</p>
        <p>‚Ä¢ <strong>Force moyenne (0.4‚Äì0.6)</strong> : modification visible mais contenu pr√©serv√©</p>
        <p>‚Ä¢ <strong>Force √©lev√©e (0.7‚Äì0.95)</strong> : transformation radicale, style tr√®s diff√©rent</p>
        <p>‚Ä¢ R√©solution : 480√ó720 ‚Äî Dur√©e : selon la vid√©o source</p>
    </div>

    <button onclick="startModification()" id="generateBtn">üé≠ Modifier la vid√©o</button>

    <div class="status" id="status"></div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
        <div class="progress-label" id="progressLabel">0 / 0</div>
    </div>

    <div class="result-video" id="resultVideo">
        <video id="finalVideo" controls></video>
        <button class="download-btn" onclick="downloadVideo()">üíæ T√©l√©charger</button>
    </div>

</div>

<script>
    let clientId = Math.random().toString(36).substring(7);
    let uploadedVideoFile = null;
    let currentVideoBlob = null;

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('open');
    }

    // ‚îÄ‚îÄ Restore comfyUrl ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('comfyUrl');
        if (saved) document.getElementById('comfyUrl').value = saved;
    });

    // ‚îÄ‚îÄ Video preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function previewVideo(event) {
        const file = event.target.files[0];
        if (!file) return;
        uploadedVideoFile = file;
        const vid = document.getElementById('videoPreview');
        if (vid.src && vid.src.startsWith('blob:')) URL.revokeObjectURL(vid.src);
        vid.src = URL.createObjectURL(file);
        vid.style.display = 'block';
        document.getElementById('videoFileText').textContent = '‚úî ' + file.name;
    }

    // ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showStatus(msg, type) {
        const s = document.getElementById('status');
        s.textContent = msg; s.className = 'status ' + type; s.style.display = 'block';
    }
    function showProgress(val, max) {
        document.getElementById('progressContainer').style.display = 'block';
        const pct = max > 0 ? Math.round((val / max) * 100) : 0;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressLabel').textContent = `Step ${val} / ${max} (${pct}%)`;
    }
    function hideProgress() {
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('progressFill').style.width = '0%';
    }

    // ‚îÄ‚îÄ Upload video to ComfyUI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function uploadVideoToComfyUI(apiUrl, file) {
        const formData = new FormData();
        formData.append('image', file, file.name);
        formData.append('overwrite', 'true');
        formData.append('type', 'input');
        const res = await fetch(`${apiUrl}/upload/image`, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`Erreur upload vid√©o (${res.status})`);
        return (await res.json()).name;
    }

    // ‚îÄ‚îÄ Main generation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function startModification() {
        const apiUrl = document.getElementById('comfyUrl').value.trim();
        const prompt = document.getElementById('prompt').value.trim();
        const strength = parseFloat(document.getElementById('strengthSlider').value);

        if (!apiUrl)              { showStatus('‚ùå Veuillez entrer l\'URL ComfyUI', 'error'); return; }
        if (!uploadedVideoFile)   { showStatus('‚ùå Veuillez uploader une vid√©o', 'error'); return; }
        if (!prompt)              { showStatus('‚ùå Veuillez entrer un prompt', 'error'); return; }

        localStorage.setItem('comfyUrl', apiUrl);
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('resultVideo').style.display = 'none';
        hideProgress();

        try {
            showStatus('üì§ Upload de la vid√©o...', 'loading');
            const videoName = await uploadVideoToComfyUI(apiUrl, uploadedVideoFile);

            showStatus('üé≠ Modification en cours...', 'loading');
            const videoBlob = await runCogVideoXV2V(apiUrl, videoName, prompt, strength);

            currentVideoBlob = videoBlob;
            const url = URL.createObjectURL(videoBlob);
            document.getElementById('finalVideo').src = url;
            document.getElementById('resultVideo').style.display = 'block';
            hideProgress();
            showStatus('‚úÖ Vid√©o modifi√©e avec succ√®s !', 'success');
        } catch(err) {
            hideProgress();
            showStatus('‚ùå Erreur : ' + err.message, 'error');
        }

        document.getElementById('generateBtn').disabled = false;
    }

    // ‚îÄ‚îÄ CogVideoX V2V workflow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function runCogVideoXV2V(apiUrl, videoName, prompt, strength) {
        return new Promise((resolve, reject) => {
            const seed = Math.floor(Math.random() * 1000000000000000);
            const uniquePrefix = `modifier/v2v_${Date.now()}`;

            const workflow = {
                // Charger la vid√©o source
                "1": {
                    inputs: { video: videoName, force_rate: 0, force_uniform_fps: true, frame_load_cap: 49, skip_first_frames: 0 },
                    class_type: "VHS_LoadVideo"
                },
                // Encoder en latent via VAE CogVideoX
                "2": {
                    inputs: { vae_name: "cogvideox_vae.safetensors" },
                    class_type: "CogVideoXVAELoader"
                },
                // Charger le mod√®le CogVideoX
                "3": {
                    inputs: { model: "CogVideoX-5b-I2V", precision: "fp16", fp8_transformer: false, compile_args: "default" },
                    class_type: "CogVideoXModelLoader"
                },
                // Charger CLIP text encoder
                "4": {
                    inputs: { clip_name: "t5xxl_fp16.safetensors", type: "sd3" },
                    class_type: "CLIPLoader"
                },
                // Encoder le prompt positif
                "5": {
                    inputs: { text: prompt, clip: ["4", 0] },
                    class_type: "CLIPTextEncode"
                },
                // Encoder le prompt n√©gatif
                "6": {
                    inputs: { text: "blurry, low quality, distorted, deformed, static, frozen, no movement, flickering", clip: ["4", 0] },
                    class_type: "CLIPTextEncode"
                },
                // Redimensionner la vid√©o source
                "7": {
                    inputs: { width: 480, height: 720, upscale_method: "lanczos", images: ["1", 0] },
                    class_type: "ImageScale"
                },
                // Encoder vid√©o source en latent
                "8": {
                    inputs: { pixels: ["7", 0], vae: ["2", 0] },
                    class_type: "CogVideoXVAEEncode"
                },
                // Sampler CogVideoX V2V avec denoise partiel
                "9": {
                    inputs: {
                        seed: seed,
                        steps: 25,
                        cfg: 6.0,
                        denoise_strength: strength,
                        scheduler: "CogVideoXDDIM",
                        positive: ["5", 0],
                        negative: ["6", 0],
                        model: ["3", 0],
                        latent_image: ["8", 0]
                    },
                    class_type: "CogVideoXSampler"
                },
                // D√©coder les latents en frames
                "10": {
                    inputs: { vae: ["2", 0], samples: ["9", 0] },
                    class_type: "CogVideoXVAEDecode"
                },
                // Cr√©er la vid√©o
                "11": {
                    inputs: { frame_rate: 24, loop_count: 0, filename_prefix: uniquePrefix, format: "video/h264-mp4", pingpong: false, save_output: true, images: ["10", 0] },
                    class_type: "VHS_VideoCombine"
                }
            };

            // D√©claration avant fetch
            let settled = false;
            let ws = null;
            const safeResolve = (val) => { if (!settled) { settled = true; if (ws) ws.close(); resolve(val); } };
            const safeReject  = (err) => { if (!settled) { settled = true; if (ws) ws.close(); reject(err); } };

            fetch(`${apiUrl}/prompt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: workflow, client_id: clientId })
            })
            .then(r => {
                if (!r.ok) return r.text().then(t => { throw new Error(`Erreur ComfyUI (${r.status}): ${t}`); });
                return r.json();
            })
            .then(data => {
                if (data.error) throw new Error('Workflow rejet√© : ' + JSON.stringify(data.error));
                const promptId = data.prompt_id;
                if (!promptId) throw new Error('Pas de prompt_id : ' + JSON.stringify(data));

                const wsUrl = apiUrl.replace(/^http/, 'ws');
                ws = new WebSocket(`${wsUrl}/ws?clientId=${clientId}`);

                ws.onmessage = async (event) => {
                    if (typeof event.data !== 'string') return;
                    let msg;
                    try { msg = JSON.parse(event.data); } catch(e) { return; }

                    if (msg.type === 'progress' && msg.data.prompt_id === promptId) {
                        showProgress(msg.data.value, msg.data.max);
                    }

                    if (msg.type === 'executing' && msg.data.prompt_id === promptId && msg.data.node === null) {
                        setTimeout(async () => {
                            try {
                                const histRes = await fetch(`${apiUrl}/history/${promptId}`);
                                if (!histRes.ok) throw new Error(`Erreur historique (${histRes.status})`);
                                const hist = await histRes.json();
                                if (hist[promptId] && hist[promptId].outputs) {
                                    const outputs = hist[promptId].outputs;
                                    // VHS_VideoCombine retourne sous "gifs" ou "videos"
                                    let videoInfo = null;
                                    for (const nodeOut of Object.values(outputs)) {
                                        const v = nodeOut.gifs || nodeOut.videos || nodeOut.images || [];
                                        if (v.length > 0) { videoInfo = v[0]; break; }
                                    }
                                    if (videoInfo) {
                                        const videoUrl = `${apiUrl}/view?filename=${encodeURIComponent(videoInfo.filename)}&subfolder=${encodeURIComponent(videoInfo.subfolder||'')}&type=${encodeURIComponent(videoInfo.type||'output')}`;
                                        const videoRes = await fetch(videoUrl);
                                        if (!videoRes.ok) throw new Error(`Erreur t√©l√©chargement (${videoRes.status})`);
                                        safeResolve(await videoRes.blob());
                                    } else {
                                        throw new Error('Aucune vid√©o dans la r√©ponse ComfyUI');
                                    }
                                } else {
                                    throw new Error('Historique introuvable');
                                }
                            } catch(err) { safeReject(err); }
                        }, 1000);
                    }
                };

                ws.onerror = () => safeReject(new Error('Erreur WebSocket ‚Äî v√©rifiez que ComfyUI est accessible'));
                ws.onclose = (e) => { if (!settled && !e.wasClean && e.code !== 1000) safeReject(new Error('WebSocket ferm√© inopin√©ment')); };
            })
            .catch(safeReject);
        });
    }

    // ‚îÄ‚îÄ Download ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function downloadVideo() {
        if (!currentVideoBlob) return;
        const url = URL.createObjectURL(currentVideoBlob);
        const a = document.createElement('a');
        a.href = url; a.download = `irisforge_modified_${Date.now()}.mp4`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    // ‚îÄ‚îÄ Traduction MyMemory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function translateToEnglish(text) {
        if (!text || !text.trim()) return null;
        try {
            const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=fr|en`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                return data.responseData.translatedText;
            }
            return null;
        } catch(e) { return null; }
    }

    async function triggerTranslate(textareaId, btnEl) {
        const ta = document.getElementById(textareaId);
        if (!ta) return;
        const original = ta.value.trim();
        if (!original) { btnEl.textContent = '‚úçÔ∏è Vide'; setTimeout(() => { btnEl.textContent = 'üåê FR‚ÜíEN'; }, 1500); return; }
        btnEl.disabled = true;
        btnEl.textContent = '‚è≥';
        try {
            const translated = await translateToEnglish(original);
            if (translated) {
                ta.value = translated;
                ta.style.transition = 'background 0.3s';
                ta.style.background = 'rgba(34,197,94,0.1)';
                setTimeout(() => { ta.style.background = ''; }, 1000);
                btnEl.textContent = '‚úÖ Traduit';
                btnEl.classList.add('success');
            } else {
                btnEl.textContent = '‚ùå Indispo';
                btnEl.classList.add('error');
            }
        } catch(e) {
            btnEl.textContent = '‚ùå Erreur';
            btnEl.classList.add('error');
        }
        setTimeout(() => {
            btnEl.disabled = false;
            btnEl.textContent = 'üåê FR‚ÜíEN';
            btnEl.classList.remove('success', 'error');
        }, 2500);
    }
</script>
</body>
</html>

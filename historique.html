<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historique - IrisForge 2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f1e;
            background-image: radial-gradient(at 20% 30%, rgba(102, 126, 234, 0.15) 0px, transparent 50%),
                              radial-gradient(at 80% 70%, rgba(118, 75, 162, 0.15) 0px, transparent 50%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #fff;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #a78bfa 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-bottom: 25px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .address-input {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }

        .address-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .card-image-container {
            position: relative;
            width: 100%;
            padding-top: 150%;
            background: rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .card-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-content {
            padding: 16px;
        }

        .card-date {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .card-filename {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-download {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .btn-download:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .btn-video {
            background: rgba(249, 115, 22, 0.2);
            color: #fb923c;
            border: 1px solid rgba(249, 115, 22, 0.3);
        }

        .btn-video:hover {
            background: rgba(249, 115, 22, 0.3);
        }

        .btn-fullscreen {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn-fullscreen:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-content {
            max-width: 95vw;
            max-height: 95vh;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-content img,
        .lightbox-content video {
            max-width: 100%;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 32px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .empty-state {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 80px 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            min-width: 300px;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #4ade80;
        }

        .notification.error {
            border-left: 4px solid #f87171;
        }

        .notification-content {
            color: white;
            font-size: 14px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Terminal Section */
        .terminal-section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-top: 30px;
        }

        .terminal-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }

        .terminal-dots {
            display: flex;
            gap: 8px;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27c93f; }

        .terminal-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .terminal-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27c93f;
            animation: pulse 2s ease-in-out infinite;
        }

        .terminal-indicator.disconnected {
            background: #ff5f56;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .terminal-content {
            background: #1a1a2e;
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .terminal-content::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .terminal-content::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        .terminal-line {
            margin-bottom: 4px;
            color: #a0a0a0;
            word-wrap: break-word;
        }

        .terminal-line.info {
            color: #4ade80;
        }

        .terminal-line.warning {
            color: #fbbf24;
        }

        .terminal-line.error {
            color: #f87171;
        }

        .terminal-line.progress {
            color: #667eea;
        }

        .terminal-line.system {
            color: #a78bfa;
        }

        .terminal-timestamp {
            color: rgba(255, 255, 255, 0.4);
            margin-right: 10px;
        }

        .terminal-controls {
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .terminal-btn {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .terminal-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Historique</h1>
            <p class="subtitle">Les 10 derni√®res g√©n√©rations</p>
            
            <div class="controls">
                <input type="text" 
                       class="address-input" 
                       id="comfyUrl" 
                       placeholder="URL ComfyUI (ex: http://127.0.0.1:8188)" 
                       value="http://127.0.0.1:8188">
                
                <button class="btn" onclick="loadHistory()" id="refreshBtn">
                    üîÑ Actualiser
                </button>
                
                <button class="btn btn-back" onclick="window.location.href='index.html'">
                    ‚Üê Retour
                </button>
            </div>
        </header>

        <div class="gallery" id="gallery"></div>

        <!-- Lightbox -->
        <div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
            <button class="lightbox-close" onclick="closeLightbox(event)">√ó</button>
            <div class="lightbox-content" id="lightboxContent"></div>
        </div>

        <!-- Terminal Section -->
        <div class="terminal-section">
            <div class="terminal-header">
                <div class="terminal-dots">
                    <div class="terminal-dot red"></div>
                    <div class="terminal-dot yellow"></div>
                    <div class="terminal-dot green"></div>
                </div>
                <div class="terminal-title">
                    üñ•Ô∏è Terminal ComfyUI
                </div>
                <div class="terminal-status">
                    <div class="terminal-indicator" id="terminalIndicator"></div>
                    <span id="terminalStatusText">Connect√©</span>
                </div>
            </div>
            <div class="terminal-content" id="terminalContent">
                <div class="terminal-line system">
                    <span class="terminal-timestamp">[--:--:--]</span>
                    En attente de connexion √† ComfyUI...
                </div>
            </div>
            <div class="terminal-controls">
                <button class="terminal-btn" onclick="clearTerminal()">üóëÔ∏è Effacer</button>
                <button class="terminal-btn" onclick="toggleAutoScroll()">
                    <span id="autoScrollIcon">üìå</span> Auto-scroll
                </button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div class="notification-content" id="notificationContent"></div>
    </div>

    <script>
        console.log('üöÄ Script charg√© !');

        let ws = null;
        let autoScroll = true;
        let pollingInterval = null;
        let lastQueueCheck = null;

        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            
            content.textContent = message;
            notif.className = `notification show ${type}`;
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }

        function addTerminalLine(message, type = 'info') {
            const terminal = document.getElementById('terminalContent');
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            line.innerHTML = `<span class="terminal-timestamp">[${timestamp}]</span>${message}`;
            
            terminal.appendChild(line);
            
            if (autoScroll) {
                terminal.scrollTop = terminal.scrollHeight;
            }
            
            while (terminal.children.length > 500) {
                terminal.removeChild(terminal.firstChild);
            }
        }

        function clearTerminal() {
            const terminal = document.getElementById('terminalContent');
            terminal.innerHTML = '<div class="terminal-line system"><span class="terminal-timestamp">[' + 
                new Date().toLocaleTimeString('fr-FR') + ']</span>Terminal effac√©</div>';
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            document.getElementById('autoScrollIcon').textContent = autoScroll ? 'üìå' : 'üìç';
            showNotification(autoScroll ? 'Auto-scroll activ√©' : 'Auto-scroll d√©sactiv√©', 'success');
        }

        function updateTerminalStatus(connected) {
            const indicator = document.getElementById('terminalIndicator');
            const statusText = document.getElementById('terminalStatusText');
            
            if (connected) {
                indicator.classList.remove('disconnected');
                statusText.textContent = 'Connect√©';
                startPolling();
            } else {
                indicator.classList.add('disconnected');
                statusText.textContent = 'D√©connect√©';
                stopPolling();
            }
        }

        async function checkQueue() {
            const apiUrl = document.getElementById('comfyUrl').value.trim();
            if (!apiUrl) return;

            try {
                const response = await fetch(`${apiUrl}/queue`);
                if (!response.ok) return;
                
                const data = await response.json();
                const running = data.queue_running || [];
                const pending = data.queue_pending || [];
                
                if (running.length > 0) {
                    for (const task of running) {
                        const promptId = task[1].substring(0, 8);
                        const currentCheck = `${promptId}_running`;
                        
                        if (lastQueueCheck !== currentCheck) {
                            addTerminalLine(`‚ö° G√©n√©ration active (ID: ${promptId}...)`, 'progress');
                            lastQueueCheck = currentCheck;
                        }
                    }
                } else if (pending.length > 0) {
                    const nextTask = pending[0];
                    const promptId = nextTask[1].substring(0, 8);
                    const currentCheck = `${promptId}_pending`;
                    
                    if (lastQueueCheck !== currentCheck) {
                        addTerminalLine(`‚è∏Ô∏è En attente (ID: ${promptId}...) - ${pending.length} t√¢che(s)`, 'info');
                        lastQueueCheck = currentCheck;
                    }
                } else {
                    if (lastQueueCheck && lastQueueCheck !== 'idle' && !lastQueueCheck.includes('pending')) {
                        addTerminalLine(`üí§ G√©n√©ration termin√©e - Rafra√Æchissement...`, 'system');
                        lastQueueCheck = 'idle';
                        setTimeout(() => {
                            addTerminalLine(`üîÑ R√©cup√©ration des nouvelles images...`, 'info');
                            loadHistory(true);
                        }, 2000);
                    } else if (!lastQueueCheck || lastQueueCheck === '') {
                        lastQueueCheck = 'idle';
                    }
                }
                
            } catch (error) {
                console.error('Erreur v√©rification queue:', error);
            }
        }

        function startPolling() {
            if (pollingInterval) return;
            pollingInterval = setInterval(checkQueue, 2000);
            checkQueue();
            addTerminalLine(`üîç Surveillance active de la queue`, 'system');
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                addTerminalLine(`‚èπÔ∏è Surveillance d√©sactiv√©e`, 'system');
            }
        }

        function connectWebSocket() {
            const apiUrl = document.getElementById('comfyUrl').value.trim();
            
            if (!apiUrl) {
                addTerminalLine('‚ö†Ô∏è Aucune URL ComfyUI configur√©e', 'warning');
                return;
            }

            if (ws) {
                ws.close();
            }

            const clientId = 'historique_monitor';
            const wsUrl = apiUrl.replace('http', 'ws') + '/ws?clientId=' + clientId;
            
            addTerminalLine(`üîå Connexion WebSocket...`, 'info');
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    addTerminalLine('‚úÖ WebSocket connect√©', 'system');
                    updateTerminalStatus(true);
                };
                
                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        
                        if (msg.type === 'status') {
                            if (msg.data?.status?.exec_info) {
                                const remaining = msg.data.status.exec_info.queue_remaining;
                                if (remaining > 0) {
                                    addTerminalLine(`üìä File d'attente: ${remaining} t√¢che(s)`, 'warning');
                                }
                            }
                        } 
                        else if (msg.type === 'progress') {
                            const p = msg.data;
                            const percent = ((p.value / p.max) * 100).toFixed(1);
                            const bar = '‚ñà'.repeat(Math.floor(percent / 5)) + '‚ñë'.repeat(20 - Math.floor(percent / 5));
                            addTerminalLine(`‚è≥ [${bar}] ${p.value}/${p.max} (${percent}%)`, 'progress');
                        }
                        else if (msg.type === 'executing') {
                            const promptId = msg.data.prompt_id ? ` - ID: ${msg.data.prompt_id.substring(0, 8)}` : '';
                            if (msg.data.node) {
                                const nodeNames = {
                                    '1': 'CheckpointLoader', '2': 'LoRA BetterFaces', '3': 'LoRA Eye Detail',
                                    '14': 'KSampler #1', '15': 'KSampler #2', '29': 'KSampler #3',
                                    '28': 'VAEDecode', '12': 'SaveImage'
                                };
                                const nodeName = nodeNames[msg.data.node] || `N≈ìud ${msg.data.node}`;
                                addTerminalLine(`üîÑ ${nodeName}${promptId}`, 'info');
                            } else {
                                addTerminalLine(`‚úÖ G√©n√©ration termin√©e${promptId}`, 'system');
                                setTimeout(() => loadHistory(true), 2000);
                            }
                        }
                        else if (msg.type === 'execution_start') {
                            const promptId = msg.data.prompt_id.substring(0, 8);
                            addTerminalLine(`üöÄ Nouvelle g√©n√©ration (ID: ${promptId}...)`, 'system');
                        }
                        else if (msg.type === 'execution_error') {
                            addTerminalLine(`‚ùå ERREUR: ${msg.data.exception_message}`, 'error');
                        }
                        
                    } catch (e) {
                        console.error('Erreur parsing WebSocket:', e);
                    }
                };
                
                ws.onerror = () => {
                    addTerminalLine('‚ùå Erreur WebSocket', 'error');
                    updateTerminalStatus(false);
                };
                
                ws.onclose = () => {
                    addTerminalLine('üîå WebSocket d√©connect√©', 'warning');
                    updateTerminalStatus(false);
                    
                    setTimeout(() => {
                        if (document.getElementById('comfyUrl').value.trim()) {
                            addTerminalLine('üîÑ Reconnexion...', 'system');
                            connectWebSocket();
                        }
                    }, 5000);
                };
                
            } catch (error) {
                addTerminalLine(`‚ùå Erreur: ${error.message}`, 'error');
                updateTerminalStatus(false);
            }
        }

        async function loadHistory(silent = false) {
            const apiUrl = document.getElementById('comfyUrl').value.trim();
            const gallery = document.getElementById('gallery');
            const btn = document.getElementById('refreshBtn');
            
            if (!apiUrl) {
                showNotification('Veuillez entrer une URL ComfyUI', 'error');
                return;
            }

            btn.disabled = true;
            if (!silent) {
                gallery.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #fff; padding: 40px;">Chargement...</div>';
            }

            try {
                const response = await fetch(`${apiUrl}/history`);
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}`);
                }

                const history = await response.json();
                
                // R√©cup√©rer toutes les images et vid√©os
                const allImages = [];
                Object.entries(history).forEach(([promptId, data]) => {
                    // Chercher dans tous les outputs possibles
                    if (data.outputs) {
                        Object.entries(data.outputs).forEach(([nodeId, output]) => {
                            // Images
                            if (output.images) {
                                output.images.forEach(img => {
                                    allImages.push({
                                        img: img,
                                        promptId: promptId,
                                        timestamp: data.status?.completed_at || 0,
                                        data: data
                                    });
                                });
                            }
                            // Vid√©os (gifs et mp4)
                            if (output.gifs) {
                                output.gifs.forEach(img => {
                                    allImages.push({
                                        img: img,
                                        promptId: promptId,
                                        timestamp: data.status?.completed_at || 0,
                                        data: data
                                    });
                                });
                            }
                        });
                    }
                });

                // Trier par timestamp (le plus r√©cent en premier), puis par num√©ro de fichier en fallback
                allImages.sort((a, b) => {
                    // Priorit√© 1 : timestamp de completion
                    if (a.timestamp && b.timestamp && a.timestamp !== b.timestamp) {
                        return b.timestamp - a.timestamp;
                    }
                    // Priorit√© 2 : extraire tous les num√©ros du nom de fichier et prendre le plus grand
                    const numsA = a.img.filename.match(/\d+/g) || ['0'];
                    const numsB = b.img.filename.match(/\d+/g) || ['0'];
                    const numA = Math.max(...numsA.map(Number));
                    const numB = Math.max(...numsB.map(Number));
                    return numB - numA;
                });
                
                console.log('üìä Ordre apr√®s tri:', allImages.map(i => i.img.filename));
                
                // Prendre les 10 premi√®res
                const toShow = allImages.slice(0, 10);
                
                // Vider et afficher
                gallery.innerHTML = '';
                
                if (toShow.length === 0) {
                    gallery.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-text">Aucune g√©n√©ration trouv√©e</div>
                        </div>
                    `;
                } else {
                    toShow.forEach(item => {
                        const card = createCard(item, apiUrl);
                        gallery.appendChild(card);
                    });
                }
                
                if (!silent) {
                    showNotification(`‚úÖ ${toShow.length} images charg√©es !`, 'success');
                    addTerminalLine(`üìö Historique charg√©: ${toShow.length} images affich√©es`, 'system');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                gallery.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-text">Erreur de chargement</div>
                    </div>
                `;
                if (!silent) {
                    showNotification('Erreur: ' + error.message, 'error');
                    addTerminalLine(`‚ùå Erreur: ${error.message}`, 'error');
                }
            } finally {
                btn.disabled = false;
            }
        }

        function createCard(item, apiUrl) {
            const card = document.createElement('div');
            card.className = 'card';

            const cacheBuster = Date.now() + Math.random();
            const imgUrl = `${apiUrl}/view?filename=${encodeURIComponent(item.img.filename)}&subfolder=${encodeURIComponent(item.img.subfolder || '')}&type=${encodeURIComponent(item.img.type || 'output')}&t=${cacheBuster}`;
            
            const date = item.timestamp ? new Date(item.timestamp * 1000) : new Date();
            const dateStr = date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // D√©tecter si c'est une vid√©o
            const isVideo = /\.(mp4|webm|mov|avi|gif)$/i.test(item.img.filename);
            const mediaElement = isVideo ? 
                `<video src="${imgUrl}" class="card-image" muted loop autoplay playsinline></video>` :
                `<img src="${imgUrl}" alt="${item.img.filename}" class="card-image" loading="lazy">`;

            card.innerHTML = `
                <div class="card-image-container">
                    ${mediaElement}
                </div>
                <div class="card-content">
                    <div class="card-date">üìÖ ${dateStr}</div>
                    <div class="card-filename" title="${item.img.filename}">${item.img.filename}</div>
                    <div class="card-actions">
                        <button class="btn-small btn-download" onclick='downloadImg("${imgUrl}", "${item.img.filename}")'>
                            üíæ
                        </button>
                        <button class="btn-small btn-video" onclick='sendToVideo("${imgUrl}")'>
                            üé¨
                        </button>
                        <button class="btn-small btn-fullscreen" onclick='openLightbox("${imgUrl}", ${isVideo})'>
                            üîç
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        async function downloadImg(url, filename) {
            try {
                addTerminalLine(`üíæ T√©l√©chargement: ${filename}`, 'info');
                const response = await fetch(url);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                showNotification('‚úÖ T√©l√©chargement lanc√© !', 'success');
                addTerminalLine(`‚úÖ T√©l√©charg√©: ${filename}`, 'system');
            } catch (error) {
                showNotification('‚ùå Erreur de t√©l√©chargement', 'error');
                addTerminalLine(`‚ùå Erreur t√©l√©chargement: ${error.message}`, 'error');
            }
        }

        async function sendToVideo(url) {
            try {
                addTerminalLine(`üé¨ Envoi vers l'√©diteur vid√©o...`, 'info');
                const response = await fetch(url);
                const blob = await response.blob();
                const reader = new FileReader();
                reader.onloadend = () => {
                    localStorage.setItem('videoSourceImage', reader.result);
                    showNotification('‚úÖ Redirection...', 'success');
                    setTimeout(() => window.location.href = 'video.html', 500);
                };
                reader.readAsDataURL(blob);
            } catch (error) {
                localStorage.setItem('videoSourceImage', url);
                window.location.href = 'video.html';
            }
        }

        function openLightbox(url, isVideo) {
            const lightbox = document.getElementById('lightbox');
            const content = document.getElementById('lightboxContent');
            
            content.innerHTML = '';
            
            if (isVideo) {
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                video.autoplay = true;
                video.style.maxWidth = '95vw';
                video.style.maxHeight = '95vh';
                content.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = url;
                img.style.maxWidth = '95vw';
                img.style.maxHeight = '95vh';
                content.appendChild(img);
            }
            
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox(event) {
            if (event.target.id === 'lightbox' || event.target.classList.contains('lightbox-close')) {
                const lightbox = document.getElementById('lightbox');
                lightbox.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                // Arr√™ter la vid√©o si c'en est une
                const video = lightbox.querySelector('video');
                if (video) {
                    video.pause();
                    video.src = '';
                }
            }
        }

        // Fermer avec la touche √âchap
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const lightbox = document.getElementById('lightbox');
                if (lightbox.classList.contains('active')) {
                    closeLightbox({ target: lightbox });
                }
            }
        });

        // Sauvegarder l'URL
        document.getElementById('comfyUrl').addEventListener('change', (e) => {
            localStorage.setItem('comfyUrl', e.target.value);
            connectWebSocket();
        });

        // Charger au d√©marrage
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üé¨ Page charg√©e');
            const savedUrl = localStorage.getItem('comfyUrl');
            if (savedUrl) {
                document.getElementById('comfyUrl').value = savedUrl;
            }
            loadHistory();
            connectWebSocket();
            
            // D√©marrer le polling m√™me si WebSocket √©choue
            setTimeout(() => {
                if (!pollingInterval) {
                    addTerminalLine('üîç D√©marrage manuel surveillance', 'system');
                    startPolling();
                }
            }, 3000);
        });

        // Raccourci F5
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                loadHistory();
            }
        });
    </script>
</body>
</html>
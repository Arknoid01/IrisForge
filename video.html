<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IrisForge">
    <title>IrisForge Video - GÃ©nÃ©rateur de VidÃ©o</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: radial-gradient(ellipse 60% 55% at 50% 55%, rgba(102,126,234,0.20) 0%, transparent 70%), radial-gradient(ellipse 40% 40% at 15% 20%, rgba(118,75,162,0.14) 0%, transparent 60%), radial-gradient(ellipse 45% 40% at 88% 80%, rgba(236,72,153,0.10) 0%, transparent 60%), #0f0f1e;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh; padding: 20px;
        }
        .container {
            background: rgba(255,255,255,0.03); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
            padding: 40px;
            padding-top: 68px; max-width: 700px; margin: 0 auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            color: #fff; font-size: 32px; font-weight: 700; margin-bottom: 8px; text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #a78bfa 50%, #ec4899 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 30px; }
        .back-link { display: inline-block; color: #a78bfa; text-decoration: none; margin-bottom: 20px; font-size: 14px; }
        .back-link:hover { color: #667eea; }
        .form-group { margin-bottom: 24px; }
        label { display: block; color: #a78bfa; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        input[type="text"], input[type="number"], textarea {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 14px; color: #fff; font-size: 14px; transition: all 0.3s;
        }
        input:focus, textarea:focus {
            outline: none; border-color: #667eea;
            background: rgba(255,255,255,0.08); box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        .file-upload {
            position: relative; display: block; width: 100%; padding: 40px 20px;
            background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;
        }
        .file-upload:hover { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .file-upload input { display: none; }
        .file-upload-text { color: rgba(255,255,255,0.6); font-size: 14px; }
        .preview-img { max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 10px; }
        button {
            width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 12px; padding: 16px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(102,126,234,0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .mode-btn { transition: all 0.3s; cursor: pointer; font-size: 14px; font-weight: 500; }
        .mode-btn.active { background: rgba(102,126,234,0.3) !important; border-color: #667eea !important; }
        .duration-options { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
        .duration-option {
            flex: 1; min-width: 120px; padding: 16px; background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1); border-radius: 12px;
            cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .duration-option:hover { background: rgba(102,126,234,0.1); border-color: rgba(102,126,234,0.3); }
        .duration-option.selected { background: rgba(102,126,234,0.2); border-color: #667eea; }
        .duration-option .duration-label { color: #fff; font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .duration-option .duration-desc { color: rgba(255,255,255,0.6); font-size: 12px; }
        .duration-option .duration-badge { display: inline-block; margin-top: 6px; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-original { background: rgba(102,126,234,0.3); color: #a78bfa; }
        .badge-recommended { background: rgba(34,197,94,0.3); color: #4ade80; }
        .badge-quality { background: rgba(236,72,153,0.3); color: #f472b6; }

        /* PROGRESS */
        .progress-container { margin-top: 16px; display: none; }
        .progress-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #a78bfa); border-radius: 4px; transition: width 0.3s ease; }
        .progress-label { text-align: center; color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 6px; }
        /* FRAME PREVIEW */
        .frame-preview-container { margin-top: 16px; display: none; text-align: center; }
        .frame-preview-container p { color: rgba(255,255,255,0.5); font-size: 12px; margin-bottom: 8px; }
        .frame-preview-img { max-width: 100%; max-height: 200px; border-radius: 10px; border: 1px solid rgba(102,126,234,0.3); box-shadow: 0 4px 20px rgba(102,126,234,0.2); }
        /* CHAINING */
        .chaining-box {
            background: rgba(167,139,250,0.08); border: 1px solid rgba(167,139,250,0.25);
            border-radius: 12px; padding: 16px; margin-bottom: 20px;
        }
        .chaining-row { display: flex; gap: 12px; align-items: center; margin-top: 10px; }
        .chaining-row span { color: rgba(255,255,255,0.6); font-size: 13px; }
        /* RESULT */
        .result-video { margin-top: 30px; text-align: center; display: none; }
        .result-video video { max-width: 100%; border-radius: 16px; box-shadow: 0 20px 50px rgba(102,126,234,0.3); }
        .download-btn { margin-top: 10px; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); }
        .next-clip-btn { margin-top: 10px; background: rgba(102,126,234,0.2); border: 1px solid rgba(102,126,234,0.4); display: none; }
        /* RECOVERY */
        .recovery-banner {
            background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3);
            border-radius: 12px; padding: 14px 16px; margin-bottom: 20px;
            display: none; align-items: center; justify-content: space-between; gap: 12px;
        }
        .recovery-banner p { color: rgba(255,255,255,0.8); font-size: 13px; }
        .recovery-btn { width: auto; padding: 8px 16px; font-size: 13px; background: rgba(251,191,36,0.3); border: 1px solid rgba(251,191,36,0.5); }
        .recovery-dismiss { width: auto; padding: 8px 16px; font-size: 13px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        /* GALLERY */
        .gallery-section { margin-top: 40px; display: none; }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .gallery-title { color: #a78bfa; font-size: 16px; font-weight: 600; }
        .gallery-actions { display: flex; gap: 8px; }
        .gallery-btn { padding: 8px 14px; font-size: 13px; border-radius: 8px; width: auto; }
        .assemble-btn { background: linear-gradient(135deg, #ec4899 0%, #a78bfa 100%); }
        .clear-btn { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
        .clip-card {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px; overflow: hidden; transition: all 0.3s; position: relative;
        }
        .clip-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .clip-card video { width: 100%; display: block; }
        .clip-card-footer { padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
        .clip-card-label { color: rgba(255,255,255,0.7); font-size: 12px; }
        .clip-card-actions { display: flex; gap: 6px; }
        .clip-action-btn {
            width: 28px; height: 28px; border-radius: 6px; border: none;
            cursor: pointer; font-size: 14px; display: flex; align-items: center;
            justify-content: center; transition: background 0.2s;
        }
        .clip-action-btn:hover { transform: none; box-shadow: none; }
        .clip-dl-btn { background: rgba(34,197,94,0.2); }
        .clip-dl-btn:hover { background: rgba(34,197,94,0.4); }
        .clip-chain-btn { background: rgba(102,126,234,0.2); }
        .clip-chain-btn:hover { background: rgba(102,126,234,0.4); }
        .clip-del-btn { background: rgba(239,68,68,0.2); }
        .clip-del-btn:hover { background: rgba(239,68,68,0.4); }
        .clip-num {
            position: absolute; top: 8px; left: 8px;
            background: rgba(0,0,0,0.6); color: #fff;
            font-size: 11px; font-weight: 700; padding: 3px 7px; border-radius: 6px;
        }
        /* â”€â”€ Sidebar â”€â”€ */
        .menu-btn { position: fixed; top: 20px; left: 20px; width: 36px; height: 36px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 9px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; cursor: pointer; z-index: 1000; transition: all 0.3s; }
        .menu-btn:hover { background: rgba(167,139,250,0.15); border-color: rgba(167,139,250,0.4); }
        .menu-btn span { display: block; width: 16px; height: 2px; background: rgba(255,255,255,0.8); border-radius: 2px; transition: all 0.3s; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1001; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sidebar-overlay.open { opacity: 1; pointer-events: all; }
        .sidebar { position: fixed; top: 0; left: 0; width: 260px; height: 100vh; background: #0f0f1e; border-right: 1px solid rgba(255,255,255,0.1); z-index: 1002; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); display: flex; flex-direction: column; padding: 24px 16px; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.07); }
        .sidebar-title { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #667eea, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sidebar-close { width: 28px; height: 28px; border-radius: 7px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .sidebar-close:hover { background: rgba(239,68,68,0.2); color: #f87171; }
        .sidebar-nav { display: flex; flex-direction: column; gap: 4px; }
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 10px; text-decoration: none; color: rgba(255,255,255,0.7); font-size: 14px; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
        .sidebar-link:hover { background: rgba(167,139,250,0.1); border-color: rgba(167,139,250,0.2); color: #fff; }
        .sidebar-link.active { background: rgba(102,126,234,0.15); border-color: rgba(102,126,234,0.3); color: #a78bfa; }
        .sidebar-link .icon { font-size: 18px; width: 24px; text-align: center; }
        .sidebar-divider { height: 1px; background: rgba(255,255,255,0.07); margin: 8px 0; }

        /* â”€â”€ TRADUCTION â”€â”€ */
        .translate-wrapper { position: relative; }
        .translate-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .translate-label-row label { margin-bottom: 0; }
        .translate-btn {
            background: rgba(102,126,234,0.2); border: 1px solid rgba(102,126,234,0.4);
            border-radius: 8px; padding: 4px 12px; color: #a78bfa;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; white-space: nowrap; width: auto;
        }
        .translate-btn:hover { background: rgba(102,126,234,0.4); color: #fff; transform: none; box-shadow: none; }
        .translate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .translate-btn.success { background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.4); color: #4ade80; }
        .translate-btn.error { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.4); color: #f87171; }
    
        /* â”€â”€ Barre de progression Style C â”€â”€ */
        .iris-progress {
            display: none;
            background: rgba(255,255,255,.03);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 14px;
            padding: 16px 20px 14px;
            margin-top: 14px;
        }
        .iris-progress.visible { display: block; }
        .iris-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 10px;
        }
        .iris-progress-status {
            font-size: 11px;
            color: rgba(255,255,255,.4);
            margin-bottom: 2px;
        }
        .iris-progress-pct {
            font-family: 'Syne', 'DM Sans', sans-serif;
            font-size: 26px; font-weight: 800; line-height: 1;
            background: linear-gradient(135deg, #fff 30%, #a78bfa 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .iris-progress-pct .unit {
            font-size: 12px;
            -webkit-text-fill-color: rgba(255,255,255,.4);
        }
        .iris-progress-right { text-align: right; }
        .iris-eta-label {
            font-size: 9px;
            color: rgba(255,255,255,.25);
            letter-spacing: 2px; text-transform: uppercase;
            margin-bottom: 3px;
        }
        .iris-eta-value {
            font-family: 'Syne', 'DM Sans', sans-serif;
            font-size: 15px; font-weight: 700;
            color: #4ade80;
            transition: color .4s;
        }
        .iris-eta-value.estimating { color: rgba(255,255,255,.3); font-size: 11px; }
        .iris-eta-value.done { color: #a78bfa; }
        .iris-progress-track {
            height: 2px;
            background: rgba(255,255,255,.07);
            border-radius: 99px;
            overflow: hidden;
        }
        .iris-progress-fill {
            height: 100%;
            border-radius: 99px;
            background: linear-gradient(90deg, #667eea, #a78bfa, #ec4899);
            background-size: 200% 100%;
            width: 0%;
            transition: width .35s cubic-bezier(.4,0,.2,1);
            animation: irisShimmer 2.5s linear infinite;
        }
        @keyframes irisShimmer {
            0%   { background-position: 200% 50%; }
            100% { background-position: -200% 50%; }
        }
        .iris-progress-sub {
            height: 1px; margin-top: 3px;
            background: rgba(255,255,255,.03);
            border-radius: 99px; overflow: hidden;
        }
        .iris-progress-sub-fill {
            height: 100%;
            background: rgba(167,139,250,.3);
            border-radius: 99px; width: 25%;
            animation: irisSubSlide 2.2s ease-in-out infinite;
        }
        @keyframes irisSubSlide {
            0%   { margin-left: 0%; width: 20%; }
            50%  { margin-left: 70%; width: 15%; }
            100% { margin-left: 0%; width: 20%; }
        }
        .iris-progress-footer {
            display: flex; justify-content: space-between;
            margin-top: 8px;
        }
        .iris-progress-steps { font-size: 11px; color: rgba(255,255,255,.25); }
        .iris-progress-speed { font-size: 11px; color: rgba(255,255,255,.18); }

        body::before {
            content: ''; position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background-image:
                linear-gradient(rgba(102,126,234,0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(102,126,234,0.04) 1px, transparent 1px);
            background-size: 60px 60px;
        }
</style>
    <link rel="stylesheet" href="iris-shared.css">
</head>
<body>
    <!-- IrisForge Topbar -->
    <div style="position:sticky;top:0;z-index:900;width:100%;box-sizing:border-box;display:flex;align-items:center;justify-content:space-between;padding:14px 24px 14px 16px;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(15,15,30,.85);backdrop-filter:blur(16px);">
        <div style="display:flex;align-items:center;gap:12px;">
            <div onclick="toggleSidebar()" style="width:34px;height:34px;border-radius:9px;background:rgba(102,126,234,.12);border:1px solid rgba(102,126,234,.25);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;cursor:pointer;" onmouseover="this.style.background='rgba(102,126,234,.25)'" onmouseout="this.style.background='rgba(102,126,234,.12)'">
                <span style="display:block;width:14px;height:2px;background:rgba(255,255,255,.8);border-radius:2px;"></span>
                <span style="display:block;width:14px;height:2px;background:rgba(255,255,255,.8);border-radius:2px;"></span>
                <span style="display:block;width:14px;height:2px;background:rgba(255,255,255,.8);border-radius:2px;"></span>
            </div>
            <a href="index.html" style="display:flex;align-items:center;gap:9px;text-decoration:none;">
                <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#667eea,#ec4899);display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 14px rgba(102,126,234,.4);flex-shrink:0;">ğŸ”¥</div>
                <div>
                    <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;background:linear-gradient(135deg,#fff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:block;line-height:1.1;">IrisForge</span>
                    <span style="font-size:8px;color:#ec4899;font-weight:600;letter-spacing:2px;text-transform:uppercase;display:block;">Graphics</span>
                </div>
            </a>
        </div>
        <span style="font-family:'Syne',sans-serif;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.3);">IRISFORGE VIDEO</span>
    </div>
        <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">ğŸ”¥ IrisForge</div>
            <div class="sidebar-close" onclick="toggleSidebar()">âœ•</div>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="sidebar-link"><span class="icon">ğŸ </span> Accueil</a>
            <div class="sidebar-divider"></div>
            <a href="forge.html" class="sidebar-link"><span class="icon">ğŸ¨</span> IrisForge 2.0</a>
            <a href="base.html" class="sidebar-link"><span class="icon">âš¡</span> IrisForge 3.0</a>
            <a href="editor.html" class="sidebar-link"><span class="icon">âœï¸</span> Ã‰diteur</a>
            <a href="video.html" class="sidebar-link active"><span class="icon">ğŸ¬</span> VidÃ©o</a>
            <a href="assemblage.html" class="sidebar-link"><span class="icon">ğŸï¸</span> Assemblage</a>
            <div class="sidebar-divider"></div>
            <a href="historique.html" class="sidebar-link"><span class="icon">ğŸ“œ</span> Historique</a>
            <a href="prompt.html" class="sidebar-link"><span class="icon">ğŸ’¬</span> Prompts</a>
            <div class="sidebar-divider"></div>
            <a href="studio.html" class="sidebar-link"><span class="icon">ğŸ¤–</span> Studio IA</a>
        </nav>
    </div>
<div class="container">
    
    <h1>ğŸ¬ IrisForge Video</h1>
    <p class="subtitle">GÃ©nÃ©rateur de vidÃ©o avec chaÃ®nage automatique</p>

    <!-- RECOVERY -->
    <div class="recovery-banner" id="recoveryBanner">
        <p>âš ï¸ Une gÃ©nÃ©ration prÃ©cÃ©dente a Ã©tÃ© dÃ©tectÃ©e. RÃ©cupÃ©rer la vidÃ©o ?</p>
        <div style="display:flex;gap:8px;">
            <button class="recovery-btn" onclick="recoverLastGeneration()">âœ… RÃ©cupÃ©rer</button>
            <button class="recovery-dismiss" onclick="dismissRecovery()">âœ• Ignorer</button>
        </div>
    </div>

    <div class="form-group">
        <label>URL ComfyUI</label>
        <input type="text" id="comfyUrl" placeholder="http://127.0.0.1:8188">
    </div>

    <div class="form-group">
        <label>Source de dÃ©part</label>
        <div style="display:flex;gap:12px;margin-bottom:12px;">
            <button type="button" class="mode-btn active" id="imageModeBtn" onclick="switchMode('image')" style="flex:1;padding:12px;background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);">ğŸ–¼ï¸ Image</button>
            <button type="button" class="mode-btn" id="videoModeBtn" onclick="switchMode('video')" style="flex:1;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);">ğŸ¬ VidÃ©o</button>
        </div>
        <div id="imageUploadSection">
            <label for="imageFile" class="file-upload">
                <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
                <div class="file-upload-text" id="imageFileText">ğŸ“¤ Cliquez pour choisir une image</div>
                <img id="imagePreview" class="preview-img" style="display:none">
            </label>
        </div>
        <div id="videoUploadSection" style="display:none;">
            <label for="videoFile" class="file-upload">
                <input type="file" id="videoFile" accept="video/*" onchange="previewVideo(event)">
                <div class="file-upload-text" id="videoFileText">ğŸ¬ Cliquez pour choisir une vidÃ©o</div>
                <video id="videoPreview" class="preview-img" style="display:none;max-width:100%;" controls></video>
            </label>
            <div style="margin-top:12px;padding:12px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;">
                <p style="color:rgba(255,255,255,0.7);font-size:13px;margin:0;">ğŸ’¡ La derniÃ¨re frame de votre vidÃ©o sera utilisÃ©e comme image de dÃ©part</p>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label>DurÃ©e du clip</label>
        <div class="duration-options">
            <div class="duration-option selected" onclick="selectDuration('2s')" id="duration2s">
                <div class="duration-label">~2 sec</div>
                <div class="duration-desc">49 frames</div>
                <div class="duration-badge badge-original">Original</div>
            </div>
            <div class="duration-option" onclick="selectDuration('4s')" id="duration4s">
                <div class="duration-label">~4 sec</div>
                <div class="duration-desc">98 frames</div>
                <div class="duration-badge badge-recommended">RecommandÃ©</div>
            </div>
            <div class="duration-option" onclick="selectDuration('7s')" id="duration7s">
                <div class="duration-label">~7 sec</div>
                <div class="duration-desc">81 frames + RIFE x2</div>
                <div class="duration-badge badge-quality">QualitÃ©+</div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <div class="translate-label-row"><label>Prompt (description du mouvement)</label><button type="button" class="translate-btn" onclick="triggerTranslate('prompt', this)">ğŸŒ FRâ†’EN</button></div>
        <textarea id="prompt" placeholder="Ex: dancing smoothly, fluid movements..."></textarea>
    </div>



    <!-- CHAINING -->
    <div class="chaining-box">
        <label>ğŸ”— ChaÃ®nage automatique</label>
        <p style="color:rgba(255,255,255,0.5);font-size:12px;margin-top:4px;">GÃ©nÃ¨re plusieurs clips en sÃ©quence. Chaque clip part de la derniÃ¨re frame du prÃ©cÃ©dent.</p>
        <div class="chaining-row">
            <input type="number" id="chainCount" value="1" min="1" max="20" style="max-width:100px;">
            <span>clip(s) Ã  gÃ©nÃ©rer</span>
        </div>
    </div>

    <button onclick="startGeneration()" id="generateBtn">ğŸ¬ GÃ©nÃ©rer</button>



        <div class="iris-progress" id="irisProgress">
            <div class="iris-progress-header">
                <div>
                    <div class="iris-progress-status" id="irisStatus">GÃ©nÃ©ration en cours...</div>
                    <div class="iris-progress-pct"><span id="irisPct">0</span><span class="unit">%</span></div>
                </div>
                <div class="iris-progress-right">
                    <div class="iris-eta-label">Temps restant</div>
                    <div class="iris-eta-value estimating" id="irisEta">Calcul...</div>
                </div>
            </div>
            <div class="iris-progress-track">
                <div class="iris-progress-fill" id="irisFill"></div>
            </div>
            <div class="iris-progress-sub"><div class="iris-progress-sub-fill"></div></div>
            <div class="iris-progress-footer">
                <span class="iris-progress-steps" id="irisSteps">Step 0 / 0</span>
                <span class="iris-progress-speed" id="irisSpeed"></span>
            </div>
        </div>

    <div class="frame-preview-container" id="framePreviewContainer">
        <p>ğŸï¸ Preview en cours de gÃ©nÃ©ration</p>
        <img class="frame-preview-img" id="framePreviewImg" src="" alt="preview">
    </div>

    <div class="result-video" id="resultVideo">
        <video id="finalVideo" controls></video>
        <button class="download-btn" onclick="downloadCurrentVideo()">ğŸ’¾ TÃ©lÃ©charger ce clip</button>
        <button class="next-clip-btn" id="nextClipBtn" onclick="generateNextClip()">â¡ï¸ GÃ©nÃ©rer le clip suivant depuis cette frame</button>
    </div>

    <!-- GALLERY -->
    <div class="gallery-section" id="gallerySection">
        <div class="gallery-header">
            <span class="gallery-title">ğŸ¬ Galerie (<span id="clipCount">0</span> clips)</span>
            <div class="gallery-actions">
                <button class="gallery-btn assemble-btn" onclick="assembleClips()">ğŸï¸ Assembler en MP4</button>
                <button class="gallery-btn clear-btn" onclick="clearGallery()">ğŸ—‘ï¸ Vider</button>
            </div>
        </div>
        <div class="gallery-grid" id="galleryGrid"></div>
    </div>
</div>

<script>
        // â”€â”€ ETA calculator (multi-pass aware) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const irisETA = {
            stepTimes: [],
            globalOffset: 0,
            globalTotal: 0,
            prevRawStep: 0,
            prevNode: null,
            reset() { this.stepTimes = []; this.globalOffset = 0; this.globalTotal = 0; this.prevRawStep = 0; this.prevNode = null; },
            setTotal(total) { this.globalTotal = total; },

            onStep(rawStep, rawMax, node) {
                const nodeChanged = node !== undefined && node !== null && node !== this.prevNode && this.prevNode !== null;
                const stepRegressed = rawStep <= this.prevRawStep && this.prevRawStep > 0;
                if (nodeChanged || (!nodeChanged && node === undefined && stepRegressed)) {
                    this.globalOffset += this.prevRawStep;
                }
                this.prevRawStep = rawStep;
                if (node !== undefined && node !== null) this.prevNode = node;

                const currentStep = this.globalOffset + rawStep;
                const totalSteps  = this.globalTotal > 0 ? this.globalTotal : (this.globalOffset + rawMax);

                this.stepTimes.push(Date.now());
                const pct  = Math.min(Math.round((currentStep / totalSteps) * 100), 99);
                const left = totalSteps - currentStep;
                let etaText = 'Calcul...', speedText = '';

                if (this.stepTimes.length >= 2) {
                    const win = this.stepTimes.slice(-8);
                    const intervals = [];
                    for (let i = 1; i < win.length; i++) intervals.push(win[i] - win[i-1]);
                    const avgMs  = intervals.reduce((a,b) => a+b, 0) / intervals.length;
                    const avgSec = avgMs / 1000;
                    const etaSec = Math.round(left * avgSec);
                    if (etaSec <= 0 || currentStep >= totalSteps) {
                        etaText = 'Finalisation...';
                    } else if (etaSec < 60) {
                        etaText = `~${etaSec}s`;
                    } else {
                        const m = Math.floor(etaSec / 60), s = etaSec % 60;
                        etaText = `~${m}m${s > 0 ? s+'s' : ''}`;
                    }
                    speedText = `${avgSec.toFixed(1)}s/step`;
                }

                const box = document.getElementById('irisProgress');
                box.classList.add('visible');
                document.getElementById('irisFill').style.width  = pct + '%';
                document.getElementById('irisPct').textContent   = pct;
                document.getElementById('irisSteps').textContent = `Step ${currentStep} / ${totalSteps}`;
                if (speedText) document.getElementById('irisSpeed').textContent = speedText;

                const etaEl = document.getElementById('irisEta');
                etaEl.textContent = etaText;
                etaEl.className   = 'iris-eta-value' + (etaText === 'Calcul...' ? ' estimating' : '');
            },

            done() {
                document.getElementById('irisStatus').textContent = 'âœ… TerminÃ© !';
                document.getElementById('irisEta').textContent    = 'âœ“';
                document.getElementById('irisEta').className      = 'iris-eta-value done';
                document.getElementById('irisFill').style.width   = '100%';
                document.getElementById('irisPct').textContent    = '100';
            },

            hide() {
                document.getElementById('irisProgress').classList.remove('visible');
                document.getElementById('irisFill').style.width   = '0%';
                document.getElementById('irisPct').textContent    = '0';
                document.getElementById('irisStatus').textContent = 'GÃ©nÃ©ration en cours...';
                document.getElementById('irisEta').textContent    = 'Calcul...';
                document.getElementById('irisEta').className      = 'iris-eta-value estimating';
                document.getElementById('irisSteps').textContent  = 'Step 0 / 0';
                document.getElementById('irisSpeed').textContent  = '';
                this.reset();
            }
        };

    // â”€â”€ INDEXEDDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const DB_NAME = 'irisforge_clips';
    const DB_VERSION = 1;
    const STORE = 'clips';
    let db = null;

    function openDB() {
        return new Promise((resolve, reject) => {
            if (db) { resolve(db); return; }
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                const d = e.target.result;
                if (!d.objectStoreNames.contains(STORE)) {
                    d.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
                }
            };
            req.onsuccess = (e) => { db = e.target.result; resolve(db); };
            req.onerror = () => reject(req.error);
        });
    }

    async function saveClipToDB(blob, label) {
        const d = await openDB();
        return new Promise((resolve, reject) => {
            const tx = d.transaction(STORE, 'readwrite');
            tx.objectStore(STORE).add({ blob, label, ts: Date.now() });
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }

    async function loadClipsFromDB() {
        const d = await openDB();
        return new Promise((resolve, reject) => {
            const req = d.transaction(STORE, 'readonly').objectStore(STORE).getAll();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }

    async function deleteClipFromDB(id) {
        const d = await openDB();
        return new Promise((resolve, reject) => {
            const tx = d.transaction(STORE, 'readwrite');
            tx.objectStore(STORE).delete(id);
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }

    async function clearDB() {
        const d = await openDB();
        return new Promise((resolve, reject) => {
            const tx = d.transaction(STORE, 'readwrite');
            tx.objectStore(STORE).clear();
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }

    // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let uploadedImage = null;
    let uploadedVideo = null;
    let currentMode = 'image';
    let selectedDuration = '2s';
            function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        let clientId = Math.random().toString(36).substring(7);
    let currentVideoBlob = null;
    let currentVideoBlobUrl = null;
    let clips = [];
    let isGenerating = false;
    let chainRemaining = 0;
    let lastFrameImage = null;

    window.addEventListener('DOMContentLoaded', () => {
        const savedUrl = localStorage.getItem('comfyUrl');
        if (savedUrl) {
            const el = document.getElementById('comfyUrl');
            if (el) el.value = savedUrl;
        }
    });

    // â”€â”€ RECOVERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function saveGenerationState(promptId, saveNodeId, apiUrl) {
        localStorage.setItem('irisforge_pending', JSON.stringify({ promptId, saveNodeId, apiUrl, page: 'video', ts: Date.now() }));
    }
    function clearGenerationState() { localStorage.removeItem('irisforge_pending'); }

    function checkRecovery() {
        try {
            const saved = localStorage.getItem('irisforge_pending');
            if (!saved) return;
            const data = JSON.parse(saved);
            if (data.page && data.page !== 'video') return;
            if (Date.now() - data.ts < 7200000) {
                document.getElementById('recoveryBanner').style.display = 'flex';
            } else { clearGenerationState(); }
        } catch(e) { clearGenerationState(); }
    }

    function dismissRecovery() {
        clearGenerationState();
        document.getElementById('recoveryBanner').style.display = 'none';
    }

    async function recoverLastGeneration() {
        let data;
        try { data = JSON.parse(localStorage.getItem('irisforge_pending')); } catch(e) { clearGenerationState(); return; }
        if (!data) return;
        document.getElementById('recoveryBanner').style.display = 'none';
        const { promptId, saveNodeId, apiUrl } = data;

        const applyVideo = async (videoInfo) => {
            const videoUrl = `${apiUrl}/view?filename=${encodeURIComponent(videoInfo.filename)}&subfolder=${encodeURIComponent(videoInfo.subfolder||'')}&type=${encodeURIComponent(videoInfo.type||'output')}`;
            const blob = await (await fetch(videoUrl)).blob();
            clearGenerationState();
            addClipToGallery(blob, selectedDuration);
            irisETA.done(); setTimeout(() => irisETA.hide(), 2000);
        };

        try {
            // Cas 1 : gÃ©nÃ©ration dÃ©jÃ  terminÃ©e
            const hist = await (await fetch(`${apiUrl}/history/${promptId}`)).json();
            if (hist[promptId] && hist[promptId].outputs) {
                const saveNode = hist[promptId].outputs[saveNodeId];
                const videoInfo = saveNode ? (saveNode.videos || saveNode.images || saveNode.gifs || [])[0] : null;
                if (videoInfo) {
                    await applyVideo(videoInfo);
                    return;
                }
            }
        } catch(e) {}

        // Cas 2 : encore en cours â†’ rebrancher WS
        irisETA.hide(); irisETA.setTotal(8);
        isGenerating = true;
        const btn = document.getElementById('generateBtn');
        if (btn) btn.disabled = true;

        const wsUrl = apiUrl.replace(/^http/, 'ws');
        const wsRecover = new WebSocket(`${wsUrl}/ws?clientId=${clientId}`);
        wsRecover.onmessage = async (event) => {
            if (typeof event.data !== 'string') return;
            let msg; try { msg = JSON.parse(event.data); } catch(e) { return; }
            if (msg.type === 'progress' && msg.data.prompt_id === promptId) {
                irisETA.onStep(msg.data.value, msg.data.max, msg.data.node);
            }
            if (msg.type === 'executing' && msg.data.prompt_id === promptId && msg.data.node === null) {
                setTimeout(async () => {
                    try {
                        const hist = await (await fetch(`${apiUrl}/history/${promptId}`)).json();
                        if (hist[promptId] && hist[promptId].outputs) {
                            const saveNode = hist[promptId].outputs[saveNodeId];
                            const videoInfo = saveNode ? (saveNode.videos || saveNode.images || saveNode.gifs || [])[0] : null;
                            if (videoInfo) await applyVideo(videoInfo);
                        }
                    } catch(e) { clearGenerationState(); }
                    finally { wsRecover.close(); isGenerating = false; if (btn) btn.disabled = false; }
                }, 1000);
            }
        };
        wsRecover.onerror = () => { isGenerating = false; if (btn) btn.disabled = false; clearGenerationState(); };
    }

    // â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showStatus(msg, type) {
        // Status text display removed â€“ progress bar only
    }
    function showProgress(val, max, node) { irisETA.onStep(val, max, node); }
    function hideProgress() { irisETA.hide(); }
    function showFramePreview(url) {
        document.getElementById('framePreviewImg').src = url;
        document.getElementById('framePreviewContainer').style.display = 'block';
    }
    function hideFramePreview() {
        document.getElementById('framePreviewContainer').style.display = 'none';
        document.getElementById('framePreviewImg').src = '';
    }
    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('imageModeBtn').classList.toggle('active', mode === 'image');
        document.getElementById('videoModeBtn').classList.toggle('active', mode === 'video');
        document.getElementById('imageUploadSection').style.display = mode === 'image' ? 'block' : 'none';
        document.getElementById('videoUploadSection').style.display = mode === 'video' ? 'block' : 'none';
    }
    function selectDuration(d) {
        selectedDuration = d;
        document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected'));
        document.getElementById('duration' + d).classList.add('selected');
        updateInfo();
    }
    function updateInfo() {
    }

    // â”€â”€ IMAGE/VIDEO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImage = e.target.result;
            lastFrameImage = e.target.result;
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('imageFileText').textContent = 'âœ” ' + file.name;
        };
        reader.readAsDataURL(file);
    }

    function previewVideo(event) {
        const file = event.target.files[0];
        if (!file) return;
        // Revoke previous object URL if any
        const vid = document.getElementById('videoPreview');
        if (vid.src && vid.src.startsWith('blob:')) URL.revokeObjectURL(vid.src);
        const url = URL.createObjectURL(file);
        uploadedVideo = file;
        uploadedImage = null; // reset until frame is extracted
        lastFrameImage = null;
        vid.src = url; vid.style.display = 'block';
        document.getElementById('videoFileText').textContent = 'âœ” ' + file.name;
        vid.onloadedmetadata = () => extractLastFrame(vid);
    }

    function extractLastFrame(video) {
        video.currentTime = Math.max(0, video.duration - 0.1);
        video.onseeked = function() {
            video.onseeked = null;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 384;
            canvas.height = video.videoHeight || 672;
            canvas.getContext('2d').drawImage(video, 0, 0);
            uploadedImage = canvas.toDataURL('image/png');
            lastFrameImage = uploadedImage;
            showStatus('âœ” DerniÃ¨re frame extraite !', 'success');

        };
    }

    function extractLastFrameFromBlob(blob) {
        return new Promise((resolve, reject) => {
            const url = URL.createObjectURL(blob);
            const video = document.createElement('video');
            const timeout = setTimeout(() => {
                URL.revokeObjectURL(url);
                reject(new Error('Timeout extraction frame'));
            }, 15000);
            video.onloadedmetadata = () => {
                video.currentTime = Math.max(0, video.duration - 0.1);
                video.onseeked = () => {
                    clearTimeout(timeout);
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth || 384;
                    canvas.height = video.videoHeight || 672;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
            };
            video.onerror = () => { clearTimeout(timeout); URL.revokeObjectURL(url); reject(new Error('Erreur chargement vidÃ©o')); };
            video.src = url;
        });
    }

    // â”€â”€ COMFYUI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function uploadImageToComfyUI(apiUrl, imageBase64) {
        const blob = await (await fetch(imageBase64)).blob();
        const formData = new FormData();
        formData.append('image', blob, `video_source_${Date.now()}.png`);
        formData.append('overwrite', 'true');
        const res = await fetch(`${apiUrl}/upload/image`, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`Erreur upload image (${res.status})`);
        return (await res.json()).name;
    }

    async function generateWithInterpolation(apiUrl, imageName, prompt) {
        return new Promise((resolve, reject) => {
            const seed = Math.floor(Math.random() * 1000000000000000);
            const uniquePrefix = `video/video_${Date.now()}`;

            // Nombre de frames selon durÃ©e
            const framesMap = { '2s': 49, '4s': 49, '7s': 81 };
            const frameCount = framesMap[selectedDuration] || 49;

            // â”€â”€ Nombre de steps selon durÃ©e â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // lightx2v Ã  pleine force (~1.0) permet de descendre Ã  8 steps total
            // sans perte de qualitÃ© perceptible sur Wan2.2 I2V.
            // Passe 1 (LOW, dÃ©bruitage grossier) : steps 0â†’4  â€” structure temporelle
            // Passe 2 (HIGH, raffinement fin)    : steps 4â†’8  â€” fidÃ©litÃ© & dÃ©tails
            const totalSteps = 8;
            const splitStep  = 4; // handoff entre LOWâ†’HIGH

            const workflow = {
                // â”€â”€ Chargement des modÃ¨les â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                "84": { inputs: { clip_name: "umt5_xxl_fp8_e4m3fn_scaled.safetensors", type: "wan" }, class_type: "CLIPLoader" },
                "90": { inputs: { vae_name: "wan_2.1_vae.safetensors" }, class_type: "VAELoader" },
                // UNet LOW : dÃ©bruitage initial (structure grossiÃ¨re)
                "95": { inputs: { unet_name: "Wan2_2-I2V-A14B-LOW_fp8_e4m3fn_scaled_KJ.safetensors", weight_dtype: "default" }, class_type: "UNETLoader" },
                // UNet HIGH : raffinement final (dÃ©tails & cohÃ©rence)
                "96": { inputs: { unet_name: "Wan2_2-I2V-A14B-HIGH_fp8_e4m3fn_scaled_KJ.safetensors", weight_dtype: "default" }, class_type: "UNETLoader" },

                // â”€â”€ Image source â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                "97":  { inputs: { image: imageName, upload: "image" }, class_type: "LoadImage" },
                "120": { inputs: { upscale_method: "lanczos", width: 384, height: 672, crop: "disabled", image: ["97", 0] }, class_type: "ImageScale" },

                // â”€â”€ Conditionnements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                "93": { inputs: { text: prompt, clip: ["84", 0] }, class_type: "CLIPTextEncode" },
                "89": { inputs: { text: "blurry, blur, out of focus, soft focus, unfocused, low quality, low resolution, pixelated, compression artifacts, jpeg artifacts, hazy, foggy, static, still image, frozen, no movement, worst quality, bad quality, ugly, distorted, deformed, flickering face, facial distortion, morphing face, inconsistent features, face deformation, glitching, temporal inconsistency, melting face, warping", clip: ["84", 0] }, class_type: "CLIPTextEncode" },

                // â”€â”€ LoRA lightx2v sur LOW (passe 1) â€” force pleine pour distillation steps â”€â”€
                "101": { inputs: { lora_name: "loras/Wan21_I2V_14B_lightx2v_cfg_step_distill_lora_rank64.safetensors", strength_model: 1.0, model: ["95", 0] }, class_type: "LoraLoaderModelOnly" },

                // â”€â”€ ModelSampling shift (stabilise le scheduler Flow) â”€â”€â”€â”€â”€â”€â”€â”€
                "103": { inputs: { shift: 5.0, model: ["101", 0] }, class_type: "ModelSamplingSD3" }, // LOW+LoRA
                "104": { inputs: { shift: 5.0, model: ["96",  0] }, class_type: "ModelSamplingSD3" }, // HIGH natif

                // â”€â”€ Conditionnement vidÃ©o partagÃ© par les deux passes â”€â”€â”€â”€â”€â”€â”€â”€
                "98": { inputs: { width: 384, height: 672, length: frameCount, batch_size: 1, positive: ["93", 0], negative: ["89", 0], vae: ["90", 0], start_image: ["120", 0] }, class_type: "WanImageToVideo" },

                // â”€â”€ Passe 1 : LOW + lightx2v â€” dÃ©bruitage grossier (steps 0â†’4) â”€â”€
                "86": { inputs: { add_noise: "enable", noise_seed: seed, steps: totalSteps, cfg: 1.0, sampler_name: "unipc", scheduler: "simple", start_at_step: 0, end_at_step: splitStep, return_with_leftover_noise: "enable", model: ["103", 0], positive: ["98", 0], negative: ["98", 1], latent_image: ["98", 2] }, class_type: "KSamplerAdvanced" },

                // â”€â”€ Passe 2 : HIGH natif â€” raffinement fin (steps 4â†’8) â”€â”€â”€â”€â”€â”€â”€
                "85": { inputs: { add_noise: "disable", noise_seed: seed, steps: totalSteps, cfg: 1.5, sampler_name: "unipc", scheduler: "simple", start_at_step: splitStep, end_at_step: totalSteps, return_with_leftover_noise: "disable", model: ["104", 0], positive: ["98", 0], negative: ["98", 1], latent_image: ["86", 0] }, class_type: "KSamplerAdvanced" },

                // â”€â”€ DÃ©codage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                "87": { inputs: { samples: ["85", 0], vae: ["90", 0] }, class_type: "VAEDecode" }
            };

            let nodeId = 200;
            let lastOutput = ["87", 0];

            // RIFE pour 4s (x2) et 7s (x2 sur 81 frames)
            if (selectedDuration === '4s' || selectedDuration === '7s') {
                workflow[String(nodeId)] = {
                    inputs: { frames: lastOutput, ckpt_name: "rife47.pth", clear_cache_after_n_frames: 10, multiplier: 2, fast_mode: true, ensemble: true, scale_factor: 1 },
                    class_type: "RIFE VFI"
                };
                lastOutput = [String(nodeId), 0];
                nodeId++;
            }

            const createId = String(nodeId++);
            workflow[createId] = { inputs: { fps: 24, images: lastOutput }, class_type: "CreateVideo" };

            const saveNodeId = String(nodeId);
            workflow[saveNodeId] = { inputs: { filename_prefix: uniquePrefix, format: "mp4", codec: "h264", video: [createId, 0] }, class_type: "SaveVideo" };

            // DÃ©claration AVANT le fetch pour Ã©viter tout problÃ¨me de temporal dead zone
            let settled = false;
            let ws = null;
            const safeResolve = (val) => { if (!settled) { settled = true; if (ws) ws.close(); resolve(val); } };
            const safeReject  = (err) => { if (!settled) { settled = true; if (ws) ws.close(); reject(err);  } };

            fetch(`${apiUrl}/prompt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: workflow, client_id: clientId })
            })
            .then(r => {
                if (!r.ok) return r.text().then(t => { throw new Error(`Erreur ComfyUI (${r.status}): ${t}`); });
                return r.json();
            })
            .then(data => {
                if (data.error) throw new Error('ComfyUI a rejetÃ© le workflow : ' + JSON.stringify(data.error));
                const promptId = data.prompt_id;
                if (!promptId) throw new Error('Pas de prompt_id dans la rÃ©ponse : ' + JSON.stringify(data));
                saveGenerationState(promptId, saveNodeId, apiUrl);

                const wsUrl = apiUrl.replace(/^http/, 'ws');
                ws = new WebSocket(`${wsUrl}/ws?clientId=${clientId}`);

                ws.onmessage = async (event) => {
                    // ComfyUI envoie parfois des previews binaires (Blob/ArrayBuffer) â€” on les ignore
                    if (typeof event.data !== 'string') return;
                    let msg;
                    try { msg = JSON.parse(event.data); } catch(e) { return; }

                    if (msg.type === 'progress' && msg.data.prompt_id === promptId) {
                        irisETA.onStep(msg.data.value, msg.data.max, msg.data.node);
                    }

                    if (msg.type === 'executed' && msg.data.prompt_id === promptId && msg.data.output) {
                        const images = msg.data.output.images || [];
                        if (images.length > 0) {
                            const img = images[0];
                            showFramePreview(`${apiUrl}/view?filename=${encodeURIComponent(img.filename)}&subfolder=${encodeURIComponent(img.subfolder||'')}&type=${encodeURIComponent(img.type||'output')}`);
                        }
                    }

                    if (msg.type === 'executing' && msg.data.prompt_id === promptId && msg.data.node === null) {
                        setTimeout(async () => {
                            try {
                                const histRes = await fetch(`${apiUrl}/history/${promptId}`);
                                if (!histRes.ok) throw new Error(`Erreur historique (${histRes.status})`);
                                const hist = await histRes.json();
                                if (hist[promptId] && hist[promptId].outputs) {
                                    const saveNode = hist[promptId].outputs[saveNodeId];
                                    const videoInfo = saveNode ? (saveNode.videos || saveNode.images || saveNode.gifs || [])[0] : null;
                                    if (videoInfo) {
                                        const videoUrl = `${apiUrl}/view?filename=${encodeURIComponent(videoInfo.filename)}&subfolder=${encodeURIComponent(videoInfo.subfolder||'')}&type=${encodeURIComponent(videoInfo.type||'output')}`;
                                        const videoRes = await fetch(videoUrl);
                                        if (!videoRes.ok) throw new Error(`Erreur tÃ©lÃ©chargement vidÃ©o (${videoRes.status})`);
                                        const videoBlob = await videoRes.blob();
                                        clearGenerationState();
                                        safeResolve({ videoBlob });
                                    } else { throw new Error('Aucune vidÃ©o dans la rÃ©ponse ComfyUI'); }
                                } else { throw new Error('Historique introuvable'); }
                            } catch(err) { safeReject(err); }
                        }, 1000);
                    }
                };

                ws.onerror = () => safeReject(new Error('Erreur WebSocket â€” vÃ©rifiez que ComfyUI est accessible'));
                ws.onclose = (e) => { if (!settled && !e.wasClean && e.code !== 1000) safeReject(new Error('WebSocket fermÃ© inopinÃ©ment')); };
            })
            .catch(safeReject);
        });
    }

    // â”€â”€ GENERATION FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    
    async function startGeneration() {
        if (isGenerating) return;
        const apiUrl = document.getElementById('comfyUrl').value.trim();
        const prompt = document.getElementById('prompt').value.trim();
        const chainCount = Math.max(1, parseInt(document.getElementById('chainCount').value) || 1);

        if (!apiUrl) { showStatus('âŒ Veuillez entrer l\'URL ComfyUI', 'error'); return; }
        localStorage.setItem('comfyUrl', apiUrl);
        if (!prompt) { showStatus('âŒ Veuillez entrer un prompt', 'error'); return; }
        if (currentMode === 'image' && !uploadedImage) { showStatus('âŒ Veuillez uploader une image', 'error'); return; }
        if (currentMode === 'video' && !uploadedImage) { showStatus('âŒ Extraction de la frame en cours, patientez...', 'error'); return; }

        chainRemaining = chainCount;
        lastFrameImage = uploadedImage;
        const translatedPrompt = await translateToEnglish(prompt);
        await runNextClip(apiUrl, translatedPrompt);
    }

    async function runNextClip(apiUrl, prompt) {
        if (chainRemaining <= 0 || !lastFrameImage) return;
        isGenerating = true;
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('nextClipBtn').style.display = 'none';
        document.getElementById('resultVideo').style.display = 'none';
        irisETA.hide(); hideFramePreview();

        const clipIndex = clips.length + 1;
        const totalExpected = clipIndex + chainRemaining - 1;

        try {
            showStatus(`ğŸ“¤ Upload image source (clip ${clipIndex}/${totalExpected})...`, 'loading');
            const imageName = await uploadImageToComfyUI(apiUrl, lastFrameImage);
            showStatus(`ğŸ¬ GÃ©nÃ©ration clip ${clipIndex}/${totalExpected}...`, 'loading'); irisETA.reset(); irisETA.setTotal(8);
            const { videoBlob } = await generateWithInterpolation(apiUrl, imageName, prompt);

            // Revoke previous result URL to free memory
            if (currentVideoBlobUrl) { URL.revokeObjectURL(currentVideoBlobUrl); currentVideoBlobUrl = null; }

            addClipToGallery(videoBlob, selectedDuration);
            currentVideoBlob = videoBlob;
            currentVideoBlobUrl = URL.createObjectURL(videoBlob);
            document.getElementById('finalVideo').src = currentVideoBlobUrl;
            document.getElementById('resultVideo').style.display = 'block';

            // Extract last frame for chaining
            lastFrameImage = await extractLastFrameFromBlob(videoBlob);

            chainRemaining--;
            irisETA.hide(); hideFramePreview();

            if (chainRemaining > 0) {
                irisETA.hide(); showStatus(`âœ… Clip ${clipIndex} terminÃ© ! Lancement du suivant...`, 'success');
                setTimeout(() => runNextClip(apiUrl, prompt), 800);
            } else {
                irisETA.done(); setTimeout(() => irisETA.hide(), 2000); showStatus(`âœ… ${clips.length} clip(s) gÃ©nÃ©rÃ©s avec succÃ¨s !`, 'success');
                document.getElementById('nextClipBtn').style.display = 'block';
                isGenerating = false;
                document.getElementById('generateBtn').disabled = false;
            }
        } catch(err) {
            irisETA.hide(); hideFramePreview();
            showStatus('âŒ Erreur : ' + err.message, 'error');
            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            if (clips.length > 0) document.getElementById('nextClipBtn').style.display = 'block';
        }
    }

    async function generateNextClip() {
        const apiUrl = document.getElementById('comfyUrl').value.trim();
        const prompt = document.getElementById('prompt').value.trim();
        if (!apiUrl) { showStatus('âŒ Veuillez entrer l\'URL ComfyUI', 'error'); return; }
        if (!prompt) { showStatus('âŒ Veuillez entrer un prompt', 'error'); return; }
        if (!lastFrameImage) { showStatus('âŒ Aucune frame source disponible', 'error'); return; }
        chainRemaining = 1;
        const translatedPrompt2 = await translateToEnglish(prompt);
        await runNextClip(apiUrl, translatedPrompt2);
    }

    // â”€â”€ GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function addClipToGallery(blob, duration) {
        const label = `Clip ${clips.length + 1} (~${duration})`;
        const url = URL.createObjectURL(blob);
        let dbId = null;
        try {
            const d = await openDB();
            dbId = await new Promise((res, rej) => {
                const tx = d.transaction(STORE, 'readwrite');
                const req = tx.objectStore(STORE).add({ blob, label, ts: Date.now() });
                req.onsuccess = () => res(req.result);
                tx.onerror = () => rej(tx.error);
            });
        } catch(e) { console.warn('IndexedDB save failed:', e); }
        clips.push({ blob, url, label, dbId });
        renderGallery();
    }

    function renderGallery() {
        const grid = document.getElementById('galleryGrid');
        const section = document.getElementById('gallerySection');
        document.getElementById('clipCount').textContent = clips.length;
        section.style.display = clips.length > 0 ? 'block' : 'none';
        grid.innerHTML = '';
        clips.forEach((clip, i) => {
            const card = document.createElement('div');
            card.className = 'clip-card';
            card.innerHTML = `
                <span class="clip-num">#${i + 1}</span>
                <video src="${clip.url}" controls muted loop playsinline></video>
                <div class="clip-card-footer">
                    <span class="clip-card-label">${clip.label}</span>
                    <div class="clip-card-actions">
                        <button class="clip-action-btn clip-chain-btn" onclick="useClipAsSource(${i})" title="Utiliser comme source">ğŸ”—</button>
                        <button class="clip-action-btn clip-dl-btn" onclick="downloadClip(${i})" title="TÃ©lÃ©charger">ğŸ’¾</button>
                        <button class="clip-action-btn clip-del-btn" onclick="deleteClip(${i})" title="Supprimer">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            grid.appendChild(card);
        });
    }

    function downloadClip(i) {
        if (i < 0 || i >= clips.length) return;
        const a = document.createElement('a');
        a.href = clips[i].url;
        a.download = `irisforge_clip_${i+1}_${Date.now()}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    async function deleteClip(i) {
        if (i < 0 || i >= clips.length) return;
        const clip = clips[i];
        URL.revokeObjectURL(clip.url);
        if (clip.dbId != null) {
            try { await deleteClipFromDB(clip.dbId); } catch(e) { console.warn('DB delete failed:', e); }
        }
        clips.splice(i, 1);
        clips.forEach((c, idx) => c.label = `Clip ${idx+1} (~${selectedDuration})`);
        // Sync labels in DB
        clips.forEach(c => { if (c.dbId != null) { try { const d = db; const tx = d.transaction(STORE, 'readwrite'); const req = tx.objectStore(STORE).get(c.dbId); req.onsuccess = () => { if(req.result) { req.result.label = c.label; tx.objectStore(STORE).put(req.result); } }; } catch(e){} } });
        renderGallery();
    }

    async function useClipAsSource(i) {
        if (i < 0 || i >= clips.length) return;
        showStatus('ğŸ”— Extraction de la derniÃ¨re frame...', 'loading');
        try {
            lastFrameImage = await extractLastFrameFromBlob(clips[i].blob);
            uploadedImage = lastFrameImage;
            document.getElementById('imagePreview').src = lastFrameImage;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('imageFileText').innerHTML = `âœ” DerniÃ¨re frame du clip #${i+1}`;
            switchMode('image');
            showStatus(`âœ… Clip #${i+1} dÃ©fini comme source !`, 'success');

        } catch(e) {
            showStatus('âŒ Erreur extraction frame : ' + e.message, 'error');
        }
    }

    async function clearGallery() {
        if (!confirm('Vider toute la galerie ? Cette action est irrÃ©versible.')) return;
        clips.forEach(c => URL.revokeObjectURL(c.url));
        clips = [];
        lastFrameImage = uploadedImage;
        try { await clearDB(); } catch(e) { console.warn('DB clear failed:', e); }
        renderGallery();
    }

    // â”€â”€ ASSEMBLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function assembleClips() {
        if (clips.length === 0) { showStatus('âŒ Aucun clip dans la galerie', 'error'); return; }
        if (clips.length === 1) { downloadClip(0); return; }

        showStatus('ğŸï¸ Assemblage en cours...', 'loading');
        try {
            const videoElements = clips.map(c => {
                const v = document.createElement('video');
                v.src = c.url; v.muted = true; v.playsInline = true;
                return v;
            });

            // Load all metadata
            await Promise.all(videoElements.map(v => new Promise((res, rej) => {
                v.onloadedmetadata = res;
                v.onerror = () => rej(new Error('Erreur chargement clip'));
                v.load();
            })));

            const W = videoElements[0].videoWidth || 384;
            const H = videoElements[0].videoHeight || 672;
            const canvas = document.createElement('canvas');
            canvas.width = W; canvas.height = H;
            const ctx = canvas.getContext('2d');

            const stream = canvas.captureStream(24);
            const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : 'video/webm';
            const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 8000000 });
            const chunks = [];
            recorder.ondataavailable = e => { if (e.data && e.data.size > 0) chunks.push(e.data); };
            recorder.start(100);

            for (let i = 0; i < videoElements.length; i++) {
                showStatus(`ğŸï¸ Assemblage clip ${i+1}/${videoElements.length}...`, 'loading');
                const v = videoElements[i];
                await new Promise((res) => {
                    v.currentTime = 0;
                    let animId;
                    let drawing = true;
                    const draw = () => {
                        if (!drawing) return;
                        ctx.drawImage(v, 0, 0, W, H);
                        animId = requestAnimationFrame(draw);
                    };
                    v.onended = () => { drawing = false; cancelAnimationFrame(animId); res(); };
                    v.onerror = () => { cancelAnimationFrame(animId); res(); }; // skip errored clip
                    v.play().then(() => { animId = requestAnimationFrame(draw); }).catch(res);
                });
                v.pause();
            }

            recorder.stop();
            await new Promise(res => recorder.onstop = res);

            const finalBlob = new Blob(chunks, { type: mimeType });
            const url = URL.createObjectURL(finalBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `irisforge_assembled_${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 5000);
            showStatus(`âœ… VidÃ©o assemblÃ©e tÃ©lÃ©chargÃ©e (${clips.length} clips) !`, 'success');
        } catch(err) { showStatus('âŒ Erreur assemblage : ' + err.message, 'error'); }
    }

    // â”€â”€ DOWNLOAD CURRENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function downloadCurrentVideo() {
        if (!currentVideoBlob) return;
        const url = URL.createObjectURL(currentVideoBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `irisforge_clip_${Date.now()}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    updateInfo();
    checkRecovery();

    // Restore clips from IndexedDB
    (async () => {
        try {
            const saved = await loadClipsFromDB();
            if (saved.length > 0) {
                for (const row of saved) {
                    const url = URL.createObjectURL(row.blob);
                    clips.push({ blob: row.blob, url, label: row.label, dbId: row.id });
                }
                renderGallery();
                showStatus(`âœ… ${saved.length} clip(s) restaurÃ©s depuis la session prÃ©cÃ©dente !`, 'success');

            }
        } catch(e) { console.warn('Could not restore clips from DB:', e); }
    })();

    window.addEventListener('load', () => {
        try {
            const img = localStorage.getItem('videoSourceImage');
            if (img) {
                const applyImage = (dataUrl) => {
                    uploadedImage = dataUrl; lastFrameImage = dataUrl;
                    document.getElementById('imagePreview').src = dataUrl;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imageFileText').innerHTML = 'âœ” Image chargÃ©e depuis IrisForge<br><small style="color:rgba(255,255,255,0.5)">Vous pouvez changer l\'image</small>';
                    localStorage.removeItem('videoSourceImage');
                };
                if (img.startsWith('data:image/')) {
                    applyImage(img);
                } else if (img.startsWith('http')) {
                    fetch(img).then(r => r.blob()).then(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => applyImage(reader.result);
                        reader.readAsDataURL(blob);
                        localStorage.removeItem('videoSourceImage');
                    }).catch(() => localStorage.removeItem('videoSourceImage'));
                }
            }
        } catch(e) { console.warn('Erreur lecture localStorage:', e); }
    });

    // â”€â”€ TRADUCTION MYMEMORY (gratuit, CORS ok) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function translateToEnglish(text) {
        if (!text || !text.trim()) return null;
        try {
            const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=fr|en`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                return data.responseData.translatedText;
            }
            return null;
        } catch(e) {
            return null;
        }
    }

    async function triggerTranslate(textareaId, btnEl) {
        const ta = document.getElementById(textareaId);
        if (!ta) return;
        const original = ta.value.trim();
        if (!original) { btnEl.textContent = 'âœï¸ Vide'; setTimeout(() => { btnEl.textContent = 'ğŸŒ FRâ†’EN'; }, 1500); return; }
        btnEl.disabled = true;
        btnEl.textContent = 'â³';
        try {
            const translated = await translateToEnglish(original);
            if (translated) {
                ta.value = translated;
                ta.style.transition = 'background 0.3s';
                ta.style.background = 'rgba(34,197,94,0.1)';
                setTimeout(() => { ta.style.background = ''; }, 1000);
                btnEl.textContent = 'âœ… Traduit';
                btnEl.classList.add('success');
            } else {
                btnEl.textContent = 'âŒ Indispo';
                btnEl.classList.add('error');
            }
        } catch(e) {
            btnEl.textContent = 'âŒ Erreur';
            btnEl.classList.add('error');
        }
        setTimeout(() => {
            btnEl.disabled = false;
            btnEl.textContent = 'ğŸŒ FRâ†’EN';
            btnEl.classList.remove('success', 'error');
        }, 2500);
    }
</script>

<script src="iris-shared.js"></script>
</body>
</html>

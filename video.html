<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IrisForge Video - G√©n√©rateur de Vid√©o</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f1e;
            background-image: radial-gradient(at 20% 30%, rgba(102, 126, 234, 0.15) 0px, transparent 50%),
                              radial-gradient(at 80% 70%, rgba(118, 75, 162, 0.15) 0px, transparent 50%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px;
            max-width: 700px;
            margin: 0 auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #fff;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #a78bfa 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-bottom: 30px;
        }
        .back-link {
            display: inline-block;
            color: #a78bfa;
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .back-link:hover { color: #667eea; }
        .form-group { margin-bottom: 24px; }
        label {
            display: block;
            color: #a78bfa;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        input[type="text"], input[type="number"], textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        .file-upload {
            position: relative;
            display: block;
            width: 100%;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .file-upload input { display: none; }
        .file-upload-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        .preview-img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .info-box p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            line-height: 1.6;
            margin: 4px 0;
        }
        .info-box strong {
            color: #a78bfa;
        }
        .warning-box {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }
        .warning-box p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            line-height: 1.6;
            margin: 4px 0;
        }
        .warning-box.show {
            display: block;
        }
        button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        .status.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }
        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        .status.loading {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }
        .result-video {
            margin-top: 30px;
            text-align: center;
            display: none;
        }
        .result-video video {
            max-width: 100%;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(102, 126, 234, 0.3);
        }
        .download-btn {
            margin-top: 16px;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
        }
        .mode-btn {
            transition: all 0.3s;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .mode-btn.active {
            background: rgba(102, 126, 234, 0.3) !important;
            border-color: #667eea !important;
        }
        .mode-btn:hover {
            background: rgba(102, 126, 234, 0.15) !important;
        }
        .duration-options {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        .duration-option {
            flex: 1;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .duration-option:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .duration-option.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }
        .duration-option .duration-label {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .duration-option .duration-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }
        .duration-option .duration-badge {
            display: inline-block;
            margin-top: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        .duration-option .badge-original {
            background: rgba(102, 126, 234, 0.3);
            color: #a78bfa;
        }
        .duration-option .badge-recommended {
            background: rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }
        .duration-option .badge-advanced {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Retour √† l'accueil</a>
        
        <h1>üé¨ IrisForge Video</h1>
        <p class="subtitle">G√©n√©rateur de vid√©o optimis√© en une requ√™te</p>

        <div class="form-group">
            <label>URL ComfyUI</label>
            <input type="text" id="comfyUrl" placeholder="http://127.0.0.1:8188" value="http://127.0.0.1:8188">
        </div>

        <div class="form-group">
            <label>Source de d√©part</label>
            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                <button type="button" class="mode-btn active" id="imageModeBtn" onclick="switchMode('image')" style="flex: 1; padding: 12px; background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.4);">
                    üñºÔ∏è Image
                </button>
                <button type="button" class="mode-btn" id="videoModeBtn" onclick="switchMode('video')" style="flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                    üé¨ Vid√©o
                </button>
            </div>

            <div id="imageUploadSection">
                <label for="imageFile" class="file-upload">
                    <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
                    <div class="file-upload-text" id="imageFileText">üì§ Cliquez pour choisir une image</div>
                    <img id="imagePreview" class="preview-img" style="display:none">
                </label>
            </div>

            <div id="videoUploadSection" style="display: none;">
                <label for="videoFile" class="file-upload">
                    <input type="file" id="videoFile" accept="video/*" onchange="previewVideo(event)">
                    <div class="file-upload-text" id="videoFileText">üé¨ Cliquez pour choisir une vid√©o</div>
                    <video id="videoPreview" class="preview-img" style="display:none; max-width: 100%;" controls></video>
                </label>
                <div style="margin-top: 12px; padding: 12px; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px;">
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin: 0;">
                        üí° La derni√®re frame de votre vid√©o sera utilis√©e comme image de d√©part
                    </p>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Dur√©e de la vid√©o</label>
            <div class="duration-options">
                <div class="duration-option selected" onclick="selectDuration('2s')" id="duration2s">
                    <div class="duration-label">~2 sec</div>
                    <div class="duration-desc">49 frames</div>
                    <div class="duration-badge badge-original">Original</div>
                </div>
                <div class="duration-option" onclick="selectDuration('4s')" id="duration4s">
                    <div class="duration-label">~4 sec</div>
                    <div class="duration-desc">98 frames</div>
                    <div class="duration-badge badge-recommended">Recommand√©</div>
                </div>
                <div class="duration-option" onclick="selectDuration('8s')" id="duration8s">
                    <div class="duration-label">~8 sec</div>
                    <div class="duration-desc">196 frames</div>
                    <div class="duration-badge badge-advanced">Avanc√©</div>
                </div>
                <div class="duration-option" onclick="selectDuration('12s')" id="duration12s">
                    <div class="duration-label">~12 sec</div>
                    <div class="duration-desc">294 frames</div>
                    <div class="duration-badge badge-advanced">Maximum</div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Prompt (description du mouvement)</label>
            <textarea id="prompt" placeholder="Ex: water flowing gently, smooth camera movement..."></textarea>
        </div>

        <div class="info-box" id="infoBox">
            <p><strong>Configuration :</strong></p>
            <p id="durationInfo">‚Ä¢ Dur√©e : ~2 secondes (49 frames)</p>
            <p id="interpolationInfo">‚Ä¢ Interpolation : Aucune</p>
            <p id="timeInfo">‚Ä¢ Temps estim√© : ~3 minutes</p>
            <p>‚Ä¢ R√©solution : 768x1536 (portrait haute qualit√©)</p>
            <p>‚Ä¢ FPS : 24 (cin√©matique)</p>
        </div>

        <div class="warning-box" id="warningBox">
            <p><strong>‚ö†Ô∏è Mode Avanc√©</strong></p>
            <p>Cette dur√©e utilise une interpolation avanc√©e. Le rendu final sera l√©g√®rement ralenti pour maintenir la fluidit√©.</p>
        </div>

        <button onclick="generateVideo()" id="generateBtn">üé¨ G√©n√©rer la vid√©o</button>

        <div class="status" id="status"></div>

        <div class="result-video" id="resultVideo">
            <video id="finalVideo" controls></video>
            <button class="download-btn" onclick="downloadVideo()">üíæ T√©l√©charger la vid√©o</button>
        </div>
    </div>

    <script>
        let uploadedImage = null;
        let uploadedVideo = null;
        let currentMode = 'image';
        let selectedDuration = '2s';
        let clientId = Math.random().toString(36).substring(7);
        let finalVideoBlob = null;

        function switchMode(mode) {
            currentMode = mode;
            
            document.getElementById('imageModeBtn').classList.toggle('active', mode === 'image');
            document.getElementById('videoModeBtn').classList.toggle('active', mode === 'video');
            
            document.getElementById('imageUploadSection').style.display = mode === 'image' ? 'block' : 'none';
            document.getElementById('videoUploadSection').style.display = mode === 'video' ? 'block' : 'none';
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImage = e.target.result;
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imageFileText').textContent = '‚úî ' + file.name;
                };
                reader.readAsDataURL(file);
            }
        }

        function previewVideo(event) {
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                uploadedVideo = file;
                document.getElementById('videoPreview').src = url;
                document.getElementById('videoPreview').style.display = 'block';
                document.getElementById('videoFileText').textContent = '‚úî ' + file.name;
                
                const video = document.getElementById('videoPreview');
                video.addEventListener('loadedmetadata', () => {
                    extractLastFrame(video);
                });
            }
        }

        function extractLastFrame(video) {
            video.currentTime = video.duration - 0.1;
            
            video.addEventListener('seeked', function onSeeked() {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                uploadedImage = canvas.toDataURL('image/png');
                
                showStatus('‚úî Derni√®re frame extraite avec succ√®s !', 'success');
                setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
                
                video.removeEventListener('seeked', onSeeked);
            }, { once: true });
        }

        function selectDuration(duration) {
            selectedDuration = duration;
            
            // Mise √† jour visuelle
            document.querySelectorAll('.duration-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('duration' + duration).classList.add('selected');
            
            // Mise √† jour des infos
            updateInfo();
        }

        function updateInfo() {
            const warningBox = document.getElementById('warningBox');
            
            if (selectedDuration === '2s') {
                document.getElementById('durationInfo').textContent = '‚Ä¢ Dur√©e : ~2 secondes (49 frames)';
                document.getElementById('interpolationInfo').textContent = '‚Ä¢ Interpolation : Aucune (qualit√© maximale)';
                document.getElementById('timeInfo').textContent = '‚Ä¢ Temps estim√© : ~45 secondes';
                warningBox.classList.remove('show');
            } else if (selectedDuration === '4s') {
                document.getElementById('durationInfo').textContent = '‚Ä¢ Dur√©e : ~4 secondes (98 frames)';
                document.getElementById('interpolationInfo').textContent = '‚Ä¢ Interpolation : RIFE x2 (bonne qualit√©)';
                document.getElementById('timeInfo').textContent = '‚Ä¢ Temps estim√© : ~2 minutes';
                warningBox.classList.remove('show');
            } else if (selectedDuration === '8s') {
                document.getElementById('durationInfo').textContent = '‚Ä¢ Dur√©e : ~8 secondes (196 frames)';
                document.getElementById('interpolationInfo').textContent = '‚Ä¢ Interpolation : RIFE x4 (qualit√© correcte)';
                document.getElementById('timeInfo').textContent = '‚Ä¢ Temps estim√© : ~4-6 minutes';
                warningBox.classList.add('show');
            } else if (selectedDuration === '12s') {
                document.getElementById('durationInfo').textContent = '‚Ä¢ Dur√©e : ~12 secondes (294 frames)';
                document.getElementById('interpolationInfo').textContent = '‚Ä¢ Interpolation : RIFE x6 (qualit√© variable)';
                document.getElementById('timeInfo').textContent = '‚Ä¢ Temps estim√© : ~8-10 minutes';
                warningBox.classList.add('show');
            }
        }

        function showStatus(msg, type) {
            const s = document.getElementById('status');
            s.textContent = msg;
            s.className = 'status ' + type;
            s.style.display = 'block';
        }

        async function uploadImageToComfyUI(apiUrl, imageBase64) {
            const response = await fetch(imageBase64);
            const blob = await response.blob();
            
            const formData = new FormData();
            formData.append('image', blob, `video_source_${Date.now()}.png`);
            formData.append('overwrite', 'true');
            
            const uploadRes = await fetch(`${apiUrl}/upload/image`, {
                method: 'POST',
                body: formData
            });
            
            if (!uploadRes.ok) {
                throw new Error('Erreur lors de l\'upload de l\'image');
            }
            
            const uploadData = await uploadRes.json();
            return uploadData.name;
        }

        async function generateVideo() {
            const apiUrl = document.getElementById('comfyUrl').value.trim();
            const userPrompt = document.getElementById('prompt').value.trim();
            const btn = document.getElementById('generateBtn');

            if (!apiUrl || !userPrompt) {
                showStatus('‚ùå Veuillez remplir tous les champs', 'error');
                return;
            }

            if (currentMode === 'image' && !uploadedImage) {
                showStatus('‚ùå Veuillez uploader une image de d√©part', 'error');
                return;
            }

            if (currentMode === 'video' && !uploadedVideo) {
                showStatus('‚ùå Veuillez uploader une vid√©o', 'error');
                return;
            }

            btn.disabled = true;
            document.getElementById('resultVideo').style.display = 'none';
            finalVideoBlob = null;

            try {
                showStatus('üì§ Upload de l\'image source...', 'loading');
                const uploadedImageName = await uploadImageToComfyUI(apiUrl, uploadedImage);
                
                showStatus('üé¨ G√©n√©ration en cours... Vous pouvez fermer cette page.', 'loading');
                const videoData = await generateWithInterpolation(apiUrl, uploadedImageName, userPrompt);
                
                finalVideoBlob = videoData.videoBlob;
                const videoBlobUrl = URL.createObjectURL(finalVideoBlob);
                
                const finalVideo = document.getElementById('finalVideo');
                finalVideo.src = videoBlobUrl;
                document.getElementById('resultVideo').style.display = 'block';
                
                showStatus('‚úÖ Vid√©o g√©n√©r√©e avec succ√®s !', 'success');
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                if (error.message.includes('out of memory') || error.message.includes('CUDA')) {
                    showStatus('‚ùå VRAM insuffisante. Essayez une dur√©e plus courte (2 secondes).', 'error');
                } else {
                    showStatus('‚ùå Erreur : ' + error.message, 'error');
                }
            } finally {
                btn.disabled = false;
            }
        }

        async function generateWithInterpolation(apiUrl, imageName, prompt) {
            return new Promise((resolve, reject) => {
                const seed = Math.floor(Math.random() * 1000000000000000);
                const timestamp = Date.now();
                const uniquePrefix = `video/video_${timestamp}`;
                
                // Workflow de base (identique √† l'original)
                const workflow = {
                    "84": { inputs: { clip_name: "umt5_xxl_fp8_e4m3fn_scaled.safetensors", type: "wan" }, class_type: "CLIPLoader" },
                    "90": { inputs: { vae_name: "wan_2.1_vae.safetensors" }, class_type: "VAELoader" },
                    "95": { inputs: { unet_name: "Wan2_2-I2V-A14B-HIGH_fp8_e4m3fn_scaled_KJ.safetensors", weight_dtype: "default" }, class_type: "UNETLoader" },
                    "96": { inputs: { unet_name: "Wan2_2-I2V-A14B-LOW_fp8_e4m3fn_scaled_KJ.safetensors", weight_dtype: "default" }, class_type: "UNETLoader" },
                    "97": { inputs: { image: imageName, upload: "image" }, class_type: "LoadImage" },
                    "120": { inputs: { upscale_method: "lanczos", width: 768, height: 1536, crop: "disabled", image: ["97", 0] }, class_type: "ImageScale" },
                    "93": { inputs: { text: prompt, clip: ["84", 0] }, class_type: "CLIPTextEncode" },
                    "89": { inputs: { text: "blurry, blur, out of focus, soft focus, unfocused, low quality, low resolution, pixelated, compression artifacts, jpeg artifacts, hazy, foggy, static, still image, frozen, no movement, worst quality, bad quality, ugly, distorted, deformed", clip: ["84", 0] }, class_type: "CLIPTextEncode" },
                    "101": { inputs: { lora_name: "loras/Wan21_I2V_14B_lightx2v_cfg_step_distill_lora_rank64.safetensors", strength_model: 1.0, model: ["95", 0] }, class_type: "LoraLoaderModelOnly" },
                    "102": { inputs: { lora_name: "DetailTweaker.safetensors", strength_model: 0.15, model: ["96", 0] }, class_type: "LoraLoaderModelOnly" },
                    "103": { inputs: { shift: 5.0, model: ["102", 0] }, class_type: "ModelSamplingSD3" },
                    "104": { inputs: { shift: 5.0, model: ["101", 0] }, class_type: "ModelSamplingSD3" },
                    "98": { inputs: { width: 768, height: 1536, length: 49, batch_size: 1, positive: ["93", 0], negative: ["89", 0], vae: ["90", 0], start_image: ["120", 0] }, class_type: "WanImageToVideo" },
                    "86": { inputs: { add_noise: "enable", noise_seed: seed, steps: 4, cfg: 2.5, sampler_name: "euler_ancestral", scheduler: "normal", start_at_step: 0, end_at_step: 2, return_with_leftover_noise: "enable", model: ["104", 0], positive: ["98", 0], negative: ["98", 1], latent_image: ["98", 2] }, class_type: "KSamplerAdvanced" },
                    "85": { inputs: { add_noise: "disable", noise_seed: seed, steps: 4, cfg: 2.5, sampler_name: "euler_ancestral", scheduler: "normal", start_at_step: 2, end_at_step: 4, return_with_leftover_noise: "disable", model: ["103", 0], positive: ["98", 0], negative: ["98", 1], latent_image: ["86", 0] }, class_type: "KSamplerAdvanced" },
                    "87": { inputs: { samples: ["85", 0], vae: ["90", 0] }, class_type: "VAEDecode" }
                };

                let currentNodeId = 200;
                let lastImageOutput = ["87", 0];
                let targetFPS = 24;

                // Ajouter l'interpolation selon la dur√©e s√©lectionn√©e
                if (selectedDuration === '4s') {
                    console.log('‚ûï Ajout RIFE VFI x2');
                    workflow[String(currentNodeId)] = {
                        inputs: {
                            frames: lastImageOutput,
                            ckpt_name: "rife47.pth",
                            clear_cache_after_n_frames: 10,
                            multiplier: 2,
                            fast_mode: true,
                            ensemble: true,
                            scale_factor: 1
                        },
                        class_type: "RIFE VFI"
                    };
                    lastImageOutput = [String(currentNodeId), 0];
                    targetFPS = 24;
                    currentNodeId++;
                } else if (selectedDuration === '8s') {
                    console.log('‚ûï Ajout RIFE VFI x4');
                    workflow[String(currentNodeId)] = {
                        inputs: {
                            frames: lastImageOutput,
                            ckpt_name: "rife47.pth",
                            clear_cache_after_n_frames: 10,
                            multiplier: 4,
                            fast_mode: true,
                            ensemble: true,
                            scale_factor: 1
                        },
                        class_type: "RIFE VFI"
                    };
                    lastImageOutput = [String(currentNodeId), 0];
                    targetFPS = 24;
                    currentNodeId++;
                } else if (selectedDuration === '12s') {
                    console.log('‚ûï Ajout RIFE VFI x6');
                    workflow[String(currentNodeId)] = {
                        inputs: {
                            frames: lastImageOutput,
                            ckpt_name: "rife47.pth",
                            clear_cache_after_n_frames: 10,
                            multiplier: 6,
                            fast_mode: true,
                            ensemble: true,
                            scale_factor: 1
                        },
                        class_type: "RIFE VFI"
                    };
                    lastImageOutput = [String(currentNodeId), 0];
                    targetFPS = 24;
                    currentNodeId++;
                }

                // Cr√©er la vid√©o avec CreateVideo
                const createVideoId = String(currentNodeId);
                workflow[createVideoId] = {
                    inputs: {
                        fps: targetFPS,
                        images: lastImageOutput
                    },
                    class_type: "CreateVideo"
                };
                currentNodeId++;

                // N≈ìud SaveVideo final
                const saveNodeId = String(currentNodeId);
                workflow[saveNodeId] = {
                    inputs: {
                        filename_prefix: uniquePrefix,
                        format: "mp4",
                        codec: "h264",
                        video: [createVideoId, 0]
                    },
                    class_type: "SaveVideo"
                };

                console.log('üì§ Envoi workflow avec dur√©e:', selectedDuration);
                console.log('üìã Workflow:', JSON.stringify(workflow, null, 2));
                
                fetch(`${apiUrl}/prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: workflow, client_id: clientId })
                })
                .then(res => res.json())
                .then(data => {
                    const promptId = data.prompt_id;
                    console.log('‚úÖ Prompt ID:', promptId);
                    
                    const ws = new WebSocket(`${apiUrl.replace('http', 'ws')}/ws?clientId=${clientId}`);
                    
                    ws.onmessage = async (event) => {
                        const msg = JSON.parse(event.data);
                        
                        if (msg.type === 'executing' && msg.data.prompt_id === promptId && msg.data.node === null) {
                            setTimeout(async () => {
                                try {
                                    const histRes = await fetch(`${apiUrl}/history/${promptId}`);
                                    const hist = await histRes.json();
                                    
                                    console.log('üì¶ Historique:', hist);
                                    
                                    if (hist[promptId] && hist[promptId].outputs) {
                                        const outputs = hist[promptId].outputs;
                                        const saveNode = outputs[saveNodeId];
                                        
                                        let videoInfo = null;
                                        
                                        if (saveNode) {
                                            if (saveNode.images && saveNode.images.length > 0) {
                                                videoInfo = saveNode.images[0];
                                            } else if (saveNode.videos && saveNode.videos.length > 0) {
                                                videoInfo = saveNode.videos[0];
                                            } else if (saveNode.gifs && saveNode.gifs.length > 0) {
                                                videoInfo = saveNode.gifs[0];
                                            }
                                        }
                                        
                                        if (videoInfo) {
                                            console.log('‚úÖ Vid√©o trouv√©e:', videoInfo);
                                            
                                            const videoUrl = `${apiUrl}/view?filename=${encodeURIComponent(videoInfo.filename)}&subfolder=${encodeURIComponent(videoInfo.subfolder || '')}&type=${encodeURIComponent(videoInfo.type || 'output')}`;
                                            
                                            const videoResponse = await fetch(videoUrl);
                                            if (!videoResponse.ok) {
                                                throw new Error(`Erreur t√©l√©chargement vid√©o: ${videoResponse.status}`);
                                            }
                                            const videoBlob = await videoResponse.blob();
                                            
                                            ws.close();
                                            resolve({ videoBlob });
                                        } else {
                                            console.error('‚ùå Pas de vid√©o dans outputs:', outputs);
                                            throw new Error('Aucune vid√©o dans la r√©ponse');
                                        }
                                    } else {
                                        throw new Error('Pas de donn√©es dans l\'historique');
                                    }
                                } catch (err) {
                                    console.error('‚ùå Erreur:', err);
                                    ws.close();
                                    reject(err);
                                }
                            }, 1000);
                        }
                    };
                    
                    ws.onerror = () => reject(new Error('Erreur WebSocket'));
                })
                .catch(reject);
            });
        }

        function downloadVideo() {
            if (finalVideoBlob) {
                const url = URL.createObjectURL(finalVideoBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `irisforge_video_${selectedDuration}_${Date.now()}.mp4`;
                link.click();
                URL.revokeObjectURL(url);
                showStatus('‚úî Vid√©o t√©l√©charg√©e !', 'success');
            } else {
                showStatus('‚ùå Aucune vid√©o disponible', 'error');
            }
        }

        updateInfo();
        
        window.addEventListener('load', () => {
            const imageFromIndex = localStorage.getItem('videoSourceImage');
            if (imageFromIndex) {
                console.log('üîç Image depuis localStorage, taille:', imageFromIndex.length);
                
                // V√©rifier format valide
                if (imageFromIndex && imageFromIndex.startsWith('data:image/')) {
                    uploadedImage = imageFromIndex;
                    document.getElementById('imagePreview').src = imageFromIndex;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imageFileText').innerHTML = '‚úî Image charg√©e depuis IrisForge<br><small style="color: rgba(255,255,255,0.5)">Vous pouvez changer l\'image si vous le souhaitez</small>';
                    
                    localStorage.removeItem('videoSourceImage');
                    
                    showStatus('‚úî Image charg√©e avec succ√®s depuis IrisForge !', 'success');
                    setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
                    console.log('‚úÖ Image OK');
                } else {
                    console.error('‚ùå Format image invalide');
                    showStatus('‚ùå Format d\'image invalide', 'error');
                    localStorage.removeItem('videoSourceImage');
                }
            }
        });
    </script>
</body>
</html>
                
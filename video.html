<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IrisForge Video - G√©n√©rateur de Vid√©o</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f1e;
            background-image: radial-gradient(at 20% 30%, rgba(102,126,234,0.15) 0px, transparent 50%),
                              radial-gradient(at 80% 70%, rgba(118,75,162,0.15) 0px, transparent 50%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            background: rgba(255,255,255,0.03); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
            padding: 40px;
            padding-top: 68px; max-width: 700px; margin: 0 auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            color: #fff; font-size: 32px; font-weight: 700; margin-bottom: 8px; text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #a78bfa 50%, #ec4899 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 30px; }
        .back-link { display: inline-block; color: #a78bfa; text-decoration: none; margin-bottom: 20px; font-size: 14px; }
        .back-link:hover { color: #667eea; }
        .form-group { margin-bottom: 24px; }
        label { display: block; color: #a78bfa; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        input[type="text"], input[type="number"], textarea {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 14px; color: #fff; font-size: 14px; transition: all 0.3s;
        }
        input:focus, textarea:focus {
            outline: none; border-color: #667eea;
            background: rgba(255,255,255,0.08); box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        .file-upload {
            position: relative; display: block; width: 100%; padding: 40px 20px;
            background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;
        }
        .file-upload:hover { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .file-upload input { display: none; }
        .file-upload-text { color: rgba(255,255,255,0.6); font-size: 14px; }
        .preview-img { max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 10px; }
        .info-box {
            background: rgba(102,126,234,0.1); border: 1px solid rgba(102,126,234,0.3);
            border-radius: 12px; padding: 16px; margin-bottom: 20px;
        }
        .info-box p { color: rgba(255,255,255,0.8); font-size: 13px; line-height: 1.6; margin: 4px 0; }
        .info-box strong { color: #a78bfa; }
        button {
            width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 12px; padding: 16px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(102,126,234,0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .mode-btn { transition: all 0.3s; cursor: pointer; font-size: 14px; font-weight: 500; }
        .mode-btn.active { background: rgba(102,126,234,0.3) !important; border-color: #667eea !important; }
        .duration-options { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
        .duration-option {
            flex: 1; min-width: 120px; padding: 16px; background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1); border-radius: 12px;
            cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .duration-option:hover { background: rgba(102,126,234,0.1); border-color: rgba(102,126,234,0.3); }
        .duration-option.selected { background: rgba(102,126,234,0.2); border-color: #667eea; }
        .duration-option .duration-label { color: #fff; font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .duration-option .duration-desc { color: rgba(255,255,255,0.6); font-size: 12px; }
        .duration-option .duration-badge { display: inline-block; margin-top: 6px; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-original { background: rgba(102,126,234,0.3); color: #a78bfa; }
        .badge-recommended { background: rgba(34,197,94,0.3); color: #4ade80; }
        .badge-quality { background: rgba(236,72,153,0.3); color: #f472b6; }
        .status { margin-top: 20px; padding: 12px; border-radius: 8px; text-align: center; font-size: 14px; display: none; }
        .status.success { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: #4ade80; }
        .status.error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #f87171; }
        .status.loading { background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); color: #fbbf24; }
        /* PROGRESS */
        .progress-container { margin-top: 16px; display: none; }
        .progress-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #a78bfa); border-radius: 4px; transition: width 0.3s ease; }
        .progress-label { text-align: center; color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 6px; }
        /* FRAME PREVIEW */
        .frame-preview-container { margin-top: 16px; display: none; text-align: center; }
        .frame-preview-container p { color: rgba(255,255,255,0.5); font-size: 12px; margin-bottom: 8px; }
        .frame-preview-img { max-width: 100%; max-height: 200px; border-radius: 10px; border: 1px solid rgba(102,126,234,0.3); box-shadow: 0 4px 20px rgba(102,126,234,0.2); }
        /* CHAINING */
        .chaining-box {
            background: rgba(167,139,250,0.08); border: 1px solid rgba(167,139,250,0.25);
            border-radius: 12px; padding: 16px; margin-bottom: 20px;
        }
        .chaining-row { display: flex; gap: 12px; align-items: center; margin-top: 10px; }
        .chaining-row span { color: rgba(255,255,255,0.6); font-size: 13px; }
        /* RESULT */
        .result-video { margin-top: 30px; text-align: center; display: none; }
        .result-video video { max-width: 100%; border-radius: 16px; box-shadow: 0 20px 50px rgba(102,126,234,0.3); }
        .download-btn { margin-top: 10px; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); }
        .next-clip-btn { margin-top: 10px; background: rgba(102,126,234,0.2); border: 1px solid rgba(102,126,234,0.4); display: none; }
        /* RECOVERY */
        .recovery-banner {
            background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3);
            border-radius: 12px; padding: 14px 16px; margin-bottom: 20px;
            display: none; align-items: center; justify-content: space-between; gap: 12px;
        }
        .recovery-banner p { color: rgba(255,255,255,0.8); font-size: 13px; }
        .recovery-btn { width: auto; padding: 8px 16px; font-size: 13px; background: rgba(251,191,36,0.3); border: 1px solid rgba(251,191,36,0.5); }
        .recovery-dismiss { width: auto; padding: 8px 16px; font-size: 13px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        /* GALLERY */
        .gallery-section { margin-top: 40px; display: none; }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .gallery-title { color: #a78bfa; font-size: 16px; font-weight: 600; }
        .gallery-actions { display: flex; gap: 8px; }
        .gallery-btn { padding: 8px 14px; font-size: 13px; border-radius: 8px; width: auto; }
        .assemble-btn { background: linear-gradient(135deg, #ec4899 0%, #a78bfa 100%); }
        .clear-btn { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
        .clip-card {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px; overflow: hidden; transition: all 0.3s; position: relative;
        }
        .clip-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .clip-card video { width: 100%; display: block; }
        .clip-card-footer { padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
        .clip-card-label { color: rgba(255,255,255,0.7); font-size: 12px; }
        .clip-card-actions { display: flex; gap: 6px; }
        .clip-action-btn {
            width: 28px; height: 28px; border-radius: 6px; border: none;
            cursor: pointer; font-size: 14px; display: flex; align-items: center;
            justify-content: center; transition: background 0.2s;
        }
        .clip-action-btn:hover { transform: none; box-shadow: none; }
        .clip-dl-btn { background: rgba(34,197,94,0.2); }
        .clip-dl-btn:hover { background: rgba(34,197,94,0.4); }
        .clip-chain-btn { background: rgba(102,126,234,0.2); }
        .clip-chain-btn:hover { background: rgba(102,126,234,0.4); }
        .clip-del-btn { background: rgba(239,68,68,0.2); }
        .clip-del-btn:hover { background: rgba(239,68,68,0.4); }
        .clip-num {
            position: absolute; top: 8px; left: 8px;
            background: rgba(0,0,0,0.6); color: #fff;
            font-size: 11px; font-weight: 700; padding: 3px 7px; border-radius: 6px;
        }
        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        .menu-btn { position: fixed; top: 20px; left: 20px; width: 36px; height: 36px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 9px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; cursor: pointer; z-index: 1000; transition: all 0.3s; }
        .menu-btn:hover { background: rgba(167,139,250,0.15); border-color: rgba(167,139,250,0.4); }
        .menu-btn span { display: block; width: 16px; height: 2px; background: rgba(255,255,255,0.8); border-radius: 2px; transition: all 0.3s; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1001; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sidebar-overlay.open { opacity: 1; pointer-events: all; }
        .sidebar { position: fixed; top: 0; left: 0; width: 260px; height: 100vh; background: #0f0f1e; border-right: 1px solid rgba(255,255,255,0.1); z-index: 1002; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); display: flex; flex-direction: column; padding: 24px 16px; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.07); }
        .sidebar-title { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #667eea, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sidebar-close { width: 28px; height: 28px; border-radius: 7px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .sidebar-close:hover { background: rgba(239,68,68,0.2); color: #f87171; }
        .sidebar-nav { display: flex; flex-direction: column; gap: 4px; }
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 10px; text-decoration: none; color: rgba(255,255,255,0.7); font-size: 14px; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
        .sidebar-link:hover { background: rgba(167,139,250,0.1); border-color: rgba(167,139,250,0.2); color: #fff; }
        .sidebar-link.active { background: rgba(102,126,234,0.15); border-color: rgba(102,126,234,0.3); color: #a78bfa; }
        .sidebar-link .icon { font-size: 18px; width: 24px; text-align: center; }
        .sidebar-divider { height: 1px; background: rgba(255,255,255,0.07); margin: 8px 0; }

        /* ‚îÄ‚îÄ TRADUCTION ‚îÄ‚îÄ */
        .translate-wrapper { position: relative; }
        .translate-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .translate-label-row label { margin-bottom: 0; }
        .translate-btn {
            background: rgba(102,126,234,0.2); border: 1px solid rgba(102,126,234,0.4);
            border-radius: 8px; padding: 4px 12px; color: #a78bfa;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; white-space: nowrap; width: auto;
        }
        .translate-btn:hover { background: rgba(102,126,234,0.4); color: #fff; transform: none; box-shadow: none; }
        .translate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .translate-btn.success { background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.4); color: #4ade80; }
        .translate-btn.error { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.4); color: #f87171; }
    </style>
</head>
<body>
    <!-- Menu -->
    <div class="menu-btn" onclick="toggleSidebar()"><span></span><span></span><span></span></div>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üî• IrisForge</div>
            <div class="sidebar-close" onclick="toggleSidebar()">‚úï</div>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="sidebar-link"><span class="icon">üè†</span> Accueil</a>
            <div class="sidebar-divider"></div>
            <a href="forge.html" class="sidebar-link"><span class="icon">üé®</span> IrisForge 2.0</a>
            <a href="base.html" class="sidebar-link"><span class="icon">‚ö°</span> Base</a>
            <a href="editor.html" class="sidebar-link"><span class="icon">‚úèÔ∏è</span> √âditeur</a>
            <a href="video.html" class="sidebar-link active"><span class="icon">üé¨</span> Vid√©o</a>
            <a href="assemblage.html" class="sidebar-link"><span class="icon">üéûÔ∏è</span> Assemblage</a>
            <div class="sidebar-divider"></div>
            <a href="historique.html" class="sidebar-link"><span class="icon">üìú</span> Historique</a>
            <a href="prompt.html" class="sidebar-link"><span class="icon">üí¨</span> Prompts</a>
        </nav>
    </div>
<div class="container">
    
    <h1>üé¨ IrisForge Video</h1>
    <p class="subtitle">G√©n√©rateur de vid√©o avec cha√Ænage automatique</p>

    <!-- RECOVERY -->
    <div class="recovery-banner" id="recoveryBanner">
        <p>‚ö†Ô∏è Une g√©n√©ration pr√©c√©dente a √©t√© d√©tect√©e. R√©cup√©rer la vid√©o ?</p>
        <div style="display:flex;gap:8px;">
            <button class="recovery-btn" onclick="recoverLastGeneration()">‚úÖ R√©cup√©rer</button>
            <button class="recovery-dismiss" onclick="dismissRecovery()">‚úï Ignorer</button>
        </div>
    </div>

    <div class="form-group">
        <label>URL ComfyUI</label>
        <input type="text" id="comfyUrl" placeholder="http://127.0.0.1:8188">
    </div>

    <div class="form-group">
        <label>Source de d√©part</label>
        <div style="display:flex;gap:12px;margin-bottom:12px;">
            <button type="button" class="mode-btn active" id="imageModeBtn" onclick="switchMode('image')" style="flex:1;padding:12px;background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);">üñºÔ∏è Image</button>
            <button type="button" class="mode-btn" id="videoModeBtn" onclick="switchMode('video')" style="flex:1;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);">üé¨ Vid√©o</button>
        </div>
        <div id="imageUploadSection">
            <label for="imageFile" class="file-upload">
                <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
                <div class="file-upload-text" id="imageFileText">üì§ Cliquez pour choisir une image</div>
                <img id="imagePreview" class="preview-img" style="display:none">
            </label>
        </div>
        <div id="videoUploadSection" style="display:none;">
            <label for="videoFile" class="file-upload">
                <input type="file" id="videoFile" accept="video/*" onchange="previewVideo(event)">
                <div class="file-upload-text" id="videoFileText">üé¨ Cliquez pour choisir une vid√©o</div>
                <video id="videoPreview" class="preview-img" style="display:none;max-width:100%;" controls></video>
            </label>
            <div style="margin-top:12px;padding:12px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;">
                <p style="color:rgba(255,255,255,0.7);font-size:13px;margin:0;">üí° La derni√®re frame de votre vid√©o sera utilis√©e comme image de d√©part</p>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label>Dur√©e du clip</label>
        <div class="duration-options">
            <div class="duration-option selected" onclick="selectDuration('2s')" id="duration2s">
                <div class="duration-label">~2 sec</div>
                <div class="duration-desc">49 frames</div>
                <div class="duration-badge badge-original">Original</div>
            </div>
            <div class="duration-option" onclick="selectDuration('4s')" id="duration4s">
                <div class="duration-label">~4 sec</div>
                <div class="duration-desc">98 frames</div>
                <div class="duration-badge badge-recommended">Recommand√©</div>
            </div>
            <div class="duration-option" onclick="selectDuration('7s')" id="duration7s">
                <div class="duration-label">~7 sec</div>
                <div class="duration-desc">81 frames + RIFE x2</div>
                <div class="duration-badge badge-quality">Qualit√©+</div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <div class="translate-label-row"><label>Prompt (description du mouvement)</label><button type="button" class="translate-btn" onclick="triggerTranslate('prompt', this)">üåê FR‚ÜíEN</button></div>
        <textarea id="prompt" placeholder="Ex: dancing smoothly, fluid movements..."></textarea>
    </div>

    <div class="info-box">
        <p><strong>Configuration :</strong></p>
        <p id="durationInfo">‚Ä¢ Dur√©e : ~2 secondes (49 frames)</p>
        <p id="interpolationInfo">‚Ä¢ Interpolation : Aucune (qualit√© maximale)</p>
        <p id="timeInfo">‚Ä¢ Temps estim√© : variable selon GPU</p>
        <p>‚Ä¢ R√©solution : 384x672 (portrait optimis√©)</p>
        <p>‚Ä¢ FPS : 24 (cin√©matique)</p>
    </div>

    <!-- CHAINING -->
    <div class="chaining-box">
        <label>üîó Cha√Ænage automatique</label>
        <p style="color:rgba(255,255,255,0.5);font-size:12px;margin-top:4px;">G√©n√®re plusieurs clips en s√©quence. Chaque clip part de la derni√®re frame du pr√©c√©dent.</p>
        <div class="chaining-row">
            <input type="number" id="chainCount" value="1" min="1" max="20" style="max-width:100px;">
            <span>clip(s) √† g√©n√©rer</span>
        </div>
    </div>

    <button onclick="startGeneration()" id="generateBtn">üé¨ G√©n√©rer</button>

    <div class="status" id="status"></div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
        <div class="progress-label" id="progressLabel">0 / 0</div>
    </div>

    <div class="frame-preview-container" id="framePreviewContainer">
        <p>üéûÔ∏è Preview en cours de g√©n√©ration</p>
        <img class="frame-preview-img" id="framePreviewImg" src="" alt="preview">
    </div>

    <div class="result-video" id="resultVideo">
        <video id="finalVideo" controls></video>
        <button class="download-btn" onclick="downloadCurrentVideo()">üíæ T√©l√©charger ce clip</button>
        <button class="next-clip-btn" id="nextClipBtn" onclick="generateNextClip()">‚û°Ô∏è G√©n√©rer le clip suivant depuis cette frame</button>
    </div>

    <!-- GALLERY -->
    <div class="gallery-section" id="gallerySection">
        <div class="gallery-header">
            <span class="gallery-title">üé¨ Galerie (<span id="clipCount">0</span> clips)</span>
            <div class="gallery-actions">
                <button class="gallery-btn assemble-btn" onclick="assembleClips()">üéûÔ∏è Assembler en MP4</button>
                <button class="gallery-btn clear-btn" onclick="clearGallery()">üóëÔ∏è Vider</button>
            </div>
        </div>
        <div class="gallery-grid" id="galleryGrid"></div>
    </div>
</div>

<script>

    // ‚îÄ‚îÄ INDEXEDDB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const DB_NAME = 'irisforge_clips';
    const DB_VERSION = 1;
    const STORE = 'clips';
    let db = null;

    function openDB() {
        return new Promise((resolve, reject) => {
            if (db) { resolve(db); return; }
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                const d = e.target.result;
                if (!d.objectStoreNames.contains(STORE)) {
                    d.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
                }
            };
            req.onsuccess = (e) => { db = e.target.result; resolve(db); };
            req.onerror = () => reject(req.error);
        });
    }

    async function saveClipToDB(blob, label) {
        const d = await openDB();
        return new Promise((resolve, reject) => {
            const tx = d.transaction(STORE, 'readwrite');
            tx.objectStore(STORE).add({ blob, label, ts: Date.now() });
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }

    async function loadClipsFromDB() {
        const d = await openDB();
        return new Promise((resolve, reject) => {
            const req = d.transaction(STORE, 'readonly').objectStore(STORE).getAll();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }

    async function deleteClipFromDB(id) {
        const d = await openDB();
        return new Promise((resolve, reject) => {
            const tx = d.transaction(STORE, 'readwrite');
            tx.objectStore(STORE).delete(id);
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }

    async function clearDB() {
        const d = await openDB();
        return new Promise((resolve, reject) => {
            const tx = d.transaction(STORE, 'readwrite');
            tx.objectStore(STORE).clear();
            tx.oncomplete = resolve;
            tx.onerror = () => reject(tx.error);
        });
    }

    // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let uploadedImage = null;
    let uploadedVideo = null;
    let currentMode = 'image';
    let selectedDuration = '2s';
            function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        let clientId = Math.random().toString(36).substring(7);
    let currentVideoBlob = null;
    let currentVideoBlobUrl = null;
    let clips = [];
    let isGenerating = false;
    let chainRemaining = 0;
    let lastFrameImage = null;

    window.addEventListener('DOMContentLoaded', () => {
        const savedUrl = localStorage.getItem('comfyUrl');
        if (savedUrl) {
            const el = document.getElementById('comfyUrl');
            if (el) el.value = savedUrl;
        }
    });

    // ‚îÄ‚îÄ RECOVERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function saveGenerationState(promptId, saveNodeId, apiUrl) {
        localStorage.setItem('irisforge_pending', JSON.stringify({ promptId, saveNodeId, apiUrl, ts: Date.now() }));
    }
    function clearGenerationState() { localStorage.removeItem('irisforge_pending'); }

    function checkRecovery() {
        try {
            const saved = localStorage.getItem('irisforge_pending');
            if (!saved) return;
            const data = JSON.parse(saved);
            if (Date.now() - data.ts < 7200000) {
                document.getElementById('recoveryBanner').style.display = 'flex';
            } else { clearGenerationState(); }
        } catch(e) { clearGenerationState(); }
    }

    function dismissRecovery() {
        clearGenerationState();
        document.getElementById('recoveryBanner').style.display = 'none';
    }

    async function recoverLastGeneration() {
        let saved;
        try { saved = localStorage.getItem('irisforge_pending'); } catch(e) {}
        if (!saved) return;
        let data;
        try { data = JSON.parse(saved); } catch(e) { clearGenerationState(); return; }
        const { promptId, saveNodeId, apiUrl } = data;
        document.getElementById('recoveryBanner').style.display = 'none';
        showStatus('üîç R√©cup√©ration de la vid√©o...', 'loading');
        try {
            const hist = await (await fetch(`${apiUrl}/history/${promptId}`)).json();
            if (hist[promptId] && hist[promptId].outputs) {
                const saveNode = hist[promptId].outputs[saveNodeId];
                const videoInfo = saveNode ? (saveNode.videos || saveNode.images || saveNode.gifs || [])[0] : null;
                if (videoInfo) {
                    const videoUrl = `${apiUrl}/view?filename=${encodeURIComponent(videoInfo.filename)}&subfolder=${encodeURIComponent(videoInfo.subfolder||'')}&type=${encodeURIComponent(videoInfo.type||'output')}`;
                    const blob = await (await fetch(videoUrl)).blob();
                    clearGenerationState();
                    addClipToGallery(blob, selectedDuration);
                    showStatus('‚úÖ Vid√©o r√©cup√©r√©e et ajout√©e √† la galerie !', 'success');
                } else {
                    showStatus('‚ö†Ô∏è G√©n√©ration pas encore termin√©e ou introuvable.', 'error');
                    clearGenerationState();
                }
            } else { showStatus('‚ö†Ô∏è Aucun r√©sultat trouv√©.', 'error'); clearGenerationState(); }
        } catch(e) { showStatus('‚ùå Erreur r√©cup√©ration : ' + e.message, 'error'); }
    }

    // ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showStatus(msg, type) {
        const s = document.getElementById('status');
        s.textContent = msg; s.className = 'status ' + type; s.style.display = 'block';
    }
    function showProgress(val, max) {
        document.getElementById('progressContainer').style.display = 'block';
        const pct = max > 0 ? Math.round((val / max) * 100) : 0;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressLabel').textContent = `Step ${val} / ${max} (${pct}%)`;
    }
    function hideProgress() {
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('progressFill').style.width = '0%';
    }
    function showFramePreview(url) {
        document.getElementById('framePreviewImg').src = url;
        document.getElementById('framePreviewContainer').style.display = 'block';
    }
    function hideFramePreview() {
        document.getElementById('framePreviewContainer').style.display = 'none';
        document.getElementById('framePreviewImg').src = '';
    }
    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('imageModeBtn').classList.toggle('active', mode === 'image');
        document.getElementById('videoModeBtn').classList.toggle('active', mode === 'video');
        document.getElementById('imageUploadSection').style.display = mode === 'image' ? 'block' : 'none';
        document.getElementById('videoUploadSection').style.display = mode === 'video' ? 'block' : 'none';
    }
    function selectDuration(d) {
        selectedDuration = d;
        document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected'));
        document.getElementById('duration' + d).classList.add('selected');
        updateInfo();
    }
    function updateInfo() {
        const infoMap = {
            '2s': { dur: '~2 secondes (49 frames)', interp: 'Aucune (qualit√© maximale)', time: 'variable selon GPU' },
            '4s': { dur: '~4 secondes (98 frames)', interp: 'RIFE x2 (bonne qualit√©)', time: 'variable selon GPU' },
            '7s': { dur: '~7 secondes (81 frames + RIFE x2)', interp: 'RIFE x2 sur 81 vraies frames (tr√®s bonne qualit√©)', time: 'variable selon GPU (~2x le mode 2s)' }
        };
        const info = infoMap[selectedDuration] || infoMap['2s'];
        document.getElementById('durationInfo').textContent = '‚Ä¢ Dur√©e : ' + info.dur;
        document.getElementById('interpolationInfo').textContent = '‚Ä¢ Interpolation : ' + info.interp;
        document.getElementById('timeInfo').textContent = '‚Ä¢ Temps estim√© : ' + info.time;
    }

    // ‚îÄ‚îÄ IMAGE/VIDEO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImage = e.target.result;
            lastFrameImage = e.target.result;
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('imageFileText').textContent = '‚úî ' + file.name;
        };
        reader.readAsDataURL(file);
    }

    function previewVideo(event) {
        const file = event.target.files[0];
        if (!file) return;
        // Revoke previous object URL if any
        const vid = document.getElementById('videoPreview');
        if (vid.src && vid.src.startsWith('blob:')) URL.revokeObjectURL(vid.src);
        const url = URL.createObjectURL(file);
        uploadedVideo = file;
        uploadedImage = null; // reset until frame is extracted
        lastFrameImage = null;
        vid.src = url; vid.style.display = 'block';
        document.getElementById('videoFileText').textContent = '‚úî ' + file.name;
        vid.onloadedmetadata = () => extractLastFrame(vid);
    }

    function extractLastFrame(video) {
        video.currentTime = Math.max(0, video.duration - 0.1);
        video.onseeked = function() {
            video.onseeked = null;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 384;
            canvas.height = video.videoHeight || 672;
            canvas.getContext('2d').drawImage(video, 0, 0);
            uploadedImage = canvas.toDataURL('image/png');
            lastFrameImage = uploadedImage;
            showStatus('‚úî Derni√®re frame extraite !', 'success');
            setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
        };
    }

    function extractLastFrameFromBlob(blob) {
        return new Promise((resolve, reject) => {
            const url = URL.createObjectURL(blob);
            const video = document.createElement('video');
            const timeout = setTimeout(() => {
                URL.revokeObjectURL(url);
                reject(new Error('Timeout extraction frame'));
            }, 15000);
            video.onloadedmetadata = () => {
                video.currentTime = Math.max(0, video.duration - 0.1);
                video.onseeked = () => {
                    clearTimeout(timeout);
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth || 384;
                    canvas.height = video.videoHeight || 672;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
            };
            video.onerror = () => { clearTimeout(timeout); URL.revokeObjectURL(url); reject(new Error('Erreur chargement vid√©o')); };
            video.src = url;
        });
    }

    // ‚îÄ‚îÄ COMFYUI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function uploadImageToComfyUI(apiUrl, imageBase64) {
        const blob = await (await fetch(imageBase64)).blob();
        const formData = new FormData();
        formData.append('image', blob, `video_source_${Date.now()}.png`);
        formData.append('overwrite', 'true');
        const res = await fetch(`${apiUrl}/upload/image`, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`Erreur upload image (${res.status})`);
        return (await res.json()).name;
    }

    async function generateWithInterpolation(apiUrl, imageName, prompt) {
        return new Promise((resolve, reject) => {
            const seed = Math.floor(Math.random() * 1000000000000000);
            const uniquePrefix = `video/video_${Date.now()}`;

            // Nombre de frames selon dur√©e
            const framesMap = { '2s': 49, '4s': 49, '7s': 81 };
            const frameCount = framesMap[selectedDuration] || 49;

            const workflow = {
                "84": { inputs: { clip_name: "umt5_xxl_fp8_e4m3fn_scaled.safetensors", type: "wan" }, class_type: "CLIPLoader" },
                "90": { inputs: { vae_name: "wan_2.1_vae.safetensors" }, class_type: "VAELoader" },
                "95": { inputs: { unet_name: "Wan2_2-I2V-A14B-HIGH_fp8_e4m3fn_scaled_KJ.safetensors", weight_dtype: "default" }, class_type: "UNETLoader" },
                "96": { inputs: { unet_name: "Wan2_2-I2V-A14B-LOW_fp8_e4m3fn_scaled_KJ.safetensors", weight_dtype: "default" }, class_type: "UNETLoader" },
                "97": { inputs: { image: imageName, upload: "image" }, class_type: "LoadImage" },
                "120": { inputs: { upscale_method: "lanczos", width: 384, height: 672, crop: "disabled", image: ["97", 0] }, class_type: "ImageScale" },
                "93": { inputs: { text: prompt, clip: ["84", 0] }, class_type: "CLIPTextEncode" },
                "89": { inputs: { text: "blurry, blur, out of focus, soft focus, unfocused, low quality, low resolution, pixelated, compression artifacts, jpeg artifacts, hazy, foggy, static, still image, frozen, no movement, worst quality, bad quality, ugly, distorted, deformed, flickering face, facial distortion, morphing face, inconsistent features, face deformation, glitching, temporal inconsistency, melting face, warping", clip: ["84", 0] }, class_type: "CLIPTextEncode" },
                "101": { inputs: { lora_name: "loras/Wan21_I2V_14B_lightx2v_cfg_step_distill_lora_rank64.safetensors", strength_model: 0.15, model: ["95", 0] }, class_type: "LoraLoaderModelOnly" },
                "102": { inputs: { lora_name: "DetailTweaker.safetensors", strength_model: 0.15, model: ["96", 0] }, class_type: "LoraLoaderModelOnly" },
                "103": { inputs: { shift: 5.0, model: ["102", 0] }, class_type: "ModelSamplingSD3" },
                "104": { inputs: { shift: 5.0, model: ["101", 0] }, class_type: "ModelSamplingSD3" },
                "98": { inputs: { width: 384, height: 672, length: frameCount, batch_size: 1, positive: ["93", 0], negative: ["89", 0], vae: ["90", 0], start_image: ["120", 0] }, class_type: "WanImageToVideo" },
                "86": { inputs: { add_noise: "enable", noise_seed: seed, steps: 25, cfg: 2.5, sampler_name: "euler_ancestral", scheduler: "normal", start_at_step: 0, end_at_step: 12, return_with_leftover_noise: "enable", model: ["104", 0], positive: ["98", 0], negative: ["98", 1], latent_image: ["98", 2] }, class_type: "KSamplerAdvanced" },
                "85": { inputs: { add_noise: "disable", noise_seed: seed, steps: 25, cfg: 2.5, sampler_name: "euler_ancestral", scheduler: "normal", start_at_step: 12, end_at_step: 25, return_with_leftover_noise: "disable", model: ["103", 0], positive: ["98", 0], negative: ["98", 1], latent_image: ["86", 0] }, class_type: "KSamplerAdvanced" },
                "87": { inputs: { samples: ["85", 0], vae: ["90", 0] }, class_type: "VAEDecode" }
            };

            let nodeId = 200;
            let lastOutput = ["87", 0];

            // RIFE pour 4s (x2) et 7s (x2 sur 81 frames)
            if (selectedDuration === '4s' || selectedDuration === '7s') {
                workflow[String(nodeId)] = {
                    inputs: { frames: lastOutput, ckpt_name: "rife47.pth", clear_cache_after_n_frames: 10, multiplier: 2, fast_mode: true, ensemble: true, scale_factor: 1 },
                    class_type: "RIFE VFI"
                };
                lastOutput = [String(nodeId), 0];
                nodeId++;
            }

            const createId = String(nodeId++);
            workflow[createId] = { inputs: { fps: 24, images: lastOutput }, class_type: "CreateVideo" };

            const saveNodeId = String(nodeId);
            workflow[saveNodeId] = { inputs: { filename_prefix: uniquePrefix, format: "mp4", codec: "h264", video: [createId, 0] }, class_type: "SaveVideo" };

            // D√©claration AVANT le fetch pour √©viter tout probl√®me de temporal dead zone
            let settled = false;
            let ws = null;
            const safeResolve = (val) => { if (!settled) { settled = true; if (ws) ws.close(); resolve(val); } };
            const safeReject  = (err) => { if (!settled) { settled = true; if (ws) ws.close(); reject(err);  } };

            fetch(`${apiUrl}/prompt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: workflow, client_id: clientId })
            })
            .then(r => {
                if (!r.ok) return r.text().then(t => { throw new Error(`Erreur ComfyUI (${r.status}): ${t}`); });
                return r.json();
            })
            .then(data => {
                if (data.error) throw new Error('ComfyUI a rejet√© le workflow : ' + JSON.stringify(data.error));
                const promptId = data.prompt_id;
                if (!promptId) throw new Error('Pas de prompt_id dans la r√©ponse : ' + JSON.stringify(data));
                saveGenerationState(promptId, saveNodeId, apiUrl);

                const wsUrl = apiUrl.replace(/^http/, 'ws');
                ws = new WebSocket(`${wsUrl}/ws?clientId=${clientId}`);

                ws.onmessage = async (event) => {
                    // ComfyUI envoie parfois des previews binaires (Blob/ArrayBuffer) ‚Äî on les ignore
                    if (typeof event.data !== 'string') return;
                    let msg;
                    try { msg = JSON.parse(event.data); } catch(e) { return; }

                    if (msg.type === 'progress' && msg.data.prompt_id === promptId) {
                        showProgress(msg.data.value, msg.data.max);
                    }

                    if (msg.type === 'executed' && msg.data.prompt_id === promptId && msg.data.output) {
                        const images = msg.data.output.images || [];
                        if (images.length > 0) {
                            const img = images[0];
                            showFramePreview(`${apiUrl}/view?filename=${encodeURIComponent(img.filename)}&subfolder=${encodeURIComponent(img.subfolder||'')}&type=${encodeURIComponent(img.type||'output')}`);
                        }
                    }

                    if (msg.type === 'executing' && msg.data.prompt_id === promptId && msg.data.node === null) {
                        setTimeout(async () => {
                            try {
                                const histRes = await fetch(`${apiUrl}/history/${promptId}`);
                                if (!histRes.ok) throw new Error(`Erreur historique (${histRes.status})`);
                                const hist = await histRes.json();
                                if (hist[promptId] && hist[promptId].outputs) {
                                    const saveNode = hist[promptId].outputs[saveNodeId];
                                    const videoInfo = saveNode ? (saveNode.videos || saveNode.images || saveNode.gifs || [])[0] : null;
                                    if (videoInfo) {
                                        const videoUrl = `${apiUrl}/view?filename=${encodeURIComponent(videoInfo.filename)}&subfolder=${encodeURIComponent(videoInfo.subfolder||'')}&type=${encodeURIComponent(videoInfo.type||'output')}`;
                                        const videoRes = await fetch(videoUrl);
                                        if (!videoRes.ok) throw new Error(`Erreur t√©l√©chargement vid√©o (${videoRes.status})`);
                                        const videoBlob = await videoRes.blob();
                                        clearGenerationState();
                                        safeResolve({ videoBlob });
                                    } else { throw new Error('Aucune vid√©o dans la r√©ponse ComfyUI'); }
                                } else { throw new Error('Historique introuvable'); }
                            } catch(err) { safeReject(err); }
                        }, 1000);
                    }
                };

                ws.onerror = () => safeReject(new Error('Erreur WebSocket ‚Äî v√©rifiez que ComfyUI est accessible'));
                ws.onclose = (e) => { if (!settled && !e.wasClean && e.code !== 1000) safeReject(new Error('WebSocket ferm√© inopin√©ment')); };
            })
            .catch(safeReject);
        });
    }

    // ‚îÄ‚îÄ GENERATION FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    
    async function startGeneration() {
        if (isGenerating) return;
        const apiUrl = document.getElementById('comfyUrl').value.trim();
        const prompt = document.getElementById('prompt').value.trim();
        const chainCount = Math.max(1, parseInt(document.getElementById('chainCount').value) || 1);

        if (!apiUrl) { showStatus('‚ùå Veuillez entrer l\'URL ComfyUI', 'error'); return; }
        localStorage.setItem('comfyUrl', apiUrl);
        if (!prompt) { showStatus('‚ùå Veuillez entrer un prompt', 'error'); return; }
        if (currentMode === 'image' && !uploadedImage) { showStatus('‚ùå Veuillez uploader une image', 'error'); return; }
        if (currentMode === 'video' && !uploadedImage) { showStatus('‚ùå Extraction de la frame en cours, patientez...', 'error'); return; }

        chainRemaining = chainCount;
        lastFrameImage = uploadedImage;
        const translatedPrompt = await translateToEnglish(prompt);
        await runNextClip(apiUrl, translatedPrompt);
    }

    async function runNextClip(apiUrl, prompt) {
        if (chainRemaining <= 0 || !lastFrameImage) return;
        isGenerating = true;
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('nextClipBtn').style.display = 'none';
        document.getElementById('resultVideo').style.display = 'none';
        hideProgress(); hideFramePreview();

        const clipIndex = clips.length + 1;
        const totalExpected = clipIndex + chainRemaining - 1;

        try {
            showStatus(`üì§ Upload image source (clip ${clipIndex}/${totalExpected})...`, 'loading');
            const imageName = await uploadImageToComfyUI(apiUrl, lastFrameImage);
            showStatus(`üé¨ G√©n√©ration clip ${clipIndex}/${totalExpected}...`, 'loading');
            const { videoBlob } = await generateWithInterpolation(apiUrl, imageName, prompt);

            // Revoke previous result URL to free memory
            if (currentVideoBlobUrl) { URL.revokeObjectURL(currentVideoBlobUrl); currentVideoBlobUrl = null; }

            addClipToGallery(videoBlob, selectedDuration);
            currentVideoBlob = videoBlob;
            currentVideoBlobUrl = URL.createObjectURL(videoBlob);
            document.getElementById('finalVideo').src = currentVideoBlobUrl;
            document.getElementById('resultVideo').style.display = 'block';

            // Extract last frame for chaining
            lastFrameImage = await extractLastFrameFromBlob(videoBlob);

            chainRemaining--;
            hideProgress(); hideFramePreview();

            if (chainRemaining > 0) {
                showStatus(`‚úÖ Clip ${clipIndex} termin√© ! Lancement du suivant...`, 'success');
                setTimeout(() => runNextClip(apiUrl, prompt), 800);
            } else {
                showStatus(`‚úÖ ${clips.length} clip(s) g√©n√©r√©s avec succ√®s !`, 'success');
                document.getElementById('nextClipBtn').style.display = 'block';
                isGenerating = false;
                document.getElementById('generateBtn').disabled = false;
            }
        } catch(err) {
            hideProgress(); hideFramePreview();
            showStatus('‚ùå Erreur : ' + err.message, 'error');
            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            if (clips.length > 0) document.getElementById('nextClipBtn').style.display = 'block';
        }
    }

    async function generateNextClip() {
        const apiUrl = document.getElementById('comfyUrl').value.trim();
        const prompt = document.getElementById('prompt').value.trim();
        if (!apiUrl) { showStatus('‚ùå Veuillez entrer l\'URL ComfyUI', 'error'); return; }
        if (!prompt) { showStatus('‚ùå Veuillez entrer un prompt', 'error'); return; }
        if (!lastFrameImage) { showStatus('‚ùå Aucune frame source disponible', 'error'); return; }
        chainRemaining = 1;
        const translatedPrompt2 = await translateToEnglish(prompt);
        await runNextClip(apiUrl, translatedPrompt2);
    }

    // ‚îÄ‚îÄ GALLERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function addClipToGallery(blob, duration) {
        const label = `Clip ${clips.length + 1} (~${duration})`;
        const url = URL.createObjectURL(blob);
        let dbId = null;
        try {
            const d = await openDB();
            dbId = await new Promise((res, rej) => {
                const tx = d.transaction(STORE, 'readwrite');
                const req = tx.objectStore(STORE).add({ blob, label, ts: Date.now() });
                req.onsuccess = () => res(req.result);
                tx.onerror = () => rej(tx.error);
            });
        } catch(e) { console.warn('IndexedDB save failed:', e); }
        clips.push({ blob, url, label, dbId });
        renderGallery();
    }

    function renderGallery() {
        const grid = document.getElementById('galleryGrid');
        const section = document.getElementById('gallerySection');
        document.getElementById('clipCount').textContent = clips.length;
        section.style.display = clips.length > 0 ? 'block' : 'none';
        grid.innerHTML = '';
        clips.forEach((clip, i) => {
            const card = document.createElement('div');
            card.className = 'clip-card';
            card.innerHTML = `
                <span class="clip-num">#${i + 1}</span>
                <video src="${clip.url}" controls muted loop playsinline></video>
                <div class="clip-card-footer">
                    <span class="clip-card-label">${clip.label}</span>
                    <div class="clip-card-actions">
                        <button class="clip-action-btn clip-chain-btn" onclick="useClipAsSource(${i})" title="Utiliser comme source">üîó</button>
                        <button class="clip-action-btn clip-dl-btn" onclick="downloadClip(${i})" title="T√©l√©charger">üíæ</button>
                        <button class="clip-action-btn clip-del-btn" onclick="deleteClip(${i})" title="Supprimer">üóëÔ∏è</button>
                    </div>
                </div>`;
            grid.appendChild(card);
        });
    }

    function downloadClip(i) {
        if (i < 0 || i >= clips.length) return;
        const a = document.createElement('a');
        a.href = clips[i].url;
        a.download = `irisforge_clip_${i+1}_${Date.now()}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    async function deleteClip(i) {
        if (i < 0 || i >= clips.length) return;
        const clip = clips[i];
        URL.revokeObjectURL(clip.url);
        if (clip.dbId != null) {
            try { await deleteClipFromDB(clip.dbId); } catch(e) { console.warn('DB delete failed:', e); }
        }
        clips.splice(i, 1);
        clips.forEach((c, idx) => c.label = `Clip ${idx+1} (~${selectedDuration})`);
        // Sync labels in DB
        clips.forEach(c => { if (c.dbId != null) { try { const d = db; const tx = d.transaction(STORE, 'readwrite'); const req = tx.objectStore(STORE).get(c.dbId); req.onsuccess = () => { if(req.result) { req.result.label = c.label; tx.objectStore(STORE).put(req.result); } }; } catch(e){} } });
        renderGallery();
    }

    async function useClipAsSource(i) {
        if (i < 0 || i >= clips.length) return;
        showStatus('üîó Extraction de la derni√®re frame...', 'loading');
        try {
            lastFrameImage = await extractLastFrameFromBlob(clips[i].blob);
            uploadedImage = lastFrameImage;
            document.getElementById('imagePreview').src = lastFrameImage;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('imageFileText').innerHTML = `‚úî Derni√®re frame du clip #${i+1}`;
            switchMode('image');
            showStatus(`‚úÖ Clip #${i+1} d√©fini comme source !`, 'success');
            setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
        } catch(e) {
            showStatus('‚ùå Erreur extraction frame : ' + e.message, 'error');
        }
    }

    async function clearGallery() {
        if (!confirm('Vider toute la galerie ? Cette action est irr√©versible.')) return;
        clips.forEach(c => URL.revokeObjectURL(c.url));
        clips = [];
        lastFrameImage = uploadedImage;
        try { await clearDB(); } catch(e) { console.warn('DB clear failed:', e); }
        renderGallery();
    }

    // ‚îÄ‚îÄ ASSEMBLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function assembleClips() {
        if (clips.length === 0) { showStatus('‚ùå Aucun clip dans la galerie', 'error'); return; }
        if (clips.length === 1) { downloadClip(0); return; }

        showStatus('üéûÔ∏è Assemblage en cours...', 'loading');
        try {
            const videoElements = clips.map(c => {
                const v = document.createElement('video');
                v.src = c.url; v.muted = true; v.playsInline = true;
                return v;
            });

            // Load all metadata
            await Promise.all(videoElements.map(v => new Promise((res, rej) => {
                v.onloadedmetadata = res;
                v.onerror = () => rej(new Error('Erreur chargement clip'));
                v.load();
            })));

            const W = videoElements[0].videoWidth || 384;
            const H = videoElements[0].videoHeight || 672;
            const canvas = document.createElement('canvas');
            canvas.width = W; canvas.height = H;
            const ctx = canvas.getContext('2d');

            const stream = canvas.captureStream(24);
            const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : 'video/webm';
            const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 8000000 });
            const chunks = [];
            recorder.ondataavailable = e => { if (e.data && e.data.size > 0) chunks.push(e.data); };
            recorder.start(100);

            for (let i = 0; i < videoElements.length; i++) {
                showStatus(`üéûÔ∏è Assemblage clip ${i+1}/${videoElements.length}...`, 'loading');
                const v = videoElements[i];
                await new Promise((res) => {
                    v.currentTime = 0;
                    let animId;
                    let drawing = true;
                    const draw = () => {
                        if (!drawing) return;
                        ctx.drawImage(v, 0, 0, W, H);
                        animId = requestAnimationFrame(draw);
                    };
                    v.onended = () => { drawing = false; cancelAnimationFrame(animId); res(); };
                    v.onerror = () => { cancelAnimationFrame(animId); res(); }; // skip errored clip
                    v.play().then(() => { animId = requestAnimationFrame(draw); }).catch(res);
                });
                v.pause();
            }

            recorder.stop();
            await new Promise(res => recorder.onstop = res);

            const finalBlob = new Blob(chunks, { type: mimeType });
            const url = URL.createObjectURL(finalBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `irisforge_assembled_${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 5000);
            showStatus(`‚úÖ Vid√©o assembl√©e t√©l√©charg√©e (${clips.length} clips) !`, 'success');
        } catch(err) { showStatus('‚ùå Erreur assemblage : ' + err.message, 'error'); }
    }

    // ‚îÄ‚îÄ DOWNLOAD CURRENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function downloadCurrentVideo() {
        if (!currentVideoBlob) return;
        const url = URL.createObjectURL(currentVideoBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `irisforge_clip_${Date.now()}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    updateInfo();
    checkRecovery();

    // Restore clips from IndexedDB
    (async () => {
        try {
            const saved = await loadClipsFromDB();
            if (saved.length > 0) {
                for (const row of saved) {
                    const url = URL.createObjectURL(row.blob);
                    clips.push({ blob: row.blob, url, label: row.label, dbId: row.id });
                }
                renderGallery();
                showStatus(`‚úÖ ${saved.length} clip(s) restaur√©s depuis la session pr√©c√©dente !`, 'success');
                setTimeout(() => document.getElementById('status').style.display = 'none', 4000);
            }
        } catch(e) { console.warn('Could not restore clips from DB:', e); }
    })();

    window.addEventListener('load', () => {
        try {
            const img = localStorage.getItem('videoSourceImage');
            if (img && img.startsWith('data:image/')) {
                uploadedImage = img; lastFrameImage = img;
                document.getElementById('imagePreview').src = img;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('imageFileText').innerHTML = '‚úî Image charg√©e depuis IrisForge<br><small style="color:rgba(255,255,255,0.5)">Vous pouvez changer l\'image</small>';
                localStorage.removeItem('videoSourceImage');
                showStatus('‚úî Image charg√©e depuis IrisForge !', 'success');
                setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
            }
        } catch(e) { console.warn('Erreur lecture localStorage:', e); }
    });

    // ‚îÄ‚îÄ TRADUCTION MYMEMORY (gratuit, CORS ok) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function translateToEnglish(text) {
        if (!text || !text.trim()) return null;
        try {
            const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=fr|en`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                return data.responseData.translatedText;
            }
            return null;
        } catch(e) {
            return null;
        }
    }

    async function triggerTranslate(textareaId, btnEl) {
        const ta = document.getElementById(textareaId);
        if (!ta) return;
        const original = ta.value.trim();
        if (!original) { btnEl.textContent = '‚úçÔ∏è Vide'; setTimeout(() => { btnEl.textContent = 'üåê FR‚ÜíEN'; }, 1500); return; }
        btnEl.disabled = true;
        btnEl.textContent = '‚è≥';
        try {
            const translated = await translateToEnglish(original);
            if (translated) {
                ta.value = translated;
                ta.style.transition = 'background 0.3s';
                ta.style.background = 'rgba(34,197,94,0.1)';
                setTimeout(() => { ta.style.background = ''; }, 1000);
                btnEl.textContent = '‚úÖ Traduit';
                btnEl.classList.add('success');
            } else {
                btnEl.textContent = '‚ùå Indispo';
                btnEl.classList.add('error');
            }
        } catch(e) {
            btnEl.textContent = '‚ùå Erreur';
            btnEl.classList.add('error');
        }
        setTimeout(() => {
            btnEl.disabled = false;
            btnEl.textContent = 'üåê FR‚ÜíEN';
            btnEl.classList.remove('success', 'error');
        }, 2500);
    }
</script>
</body>
</html>
